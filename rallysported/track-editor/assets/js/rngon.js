(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Rngon:()=>re});const r="object"==typeof window?void 0:function(e,t){if(!e)throw new Error(t)},n="object"==typeof window?void 0:function(e,t,o=t.properties,a=""){r?.(e&&"object"==typeof e,"Schemas can't be evaluated for non-object types."),r?.(t&&"object"==typeof t&&o&&"object"==typeof o&&"string"==typeof a,"Malformed schema.");{const r=Object.keys(e),n=Object.keys(o).filter((e=>!r.includes(e))).filter((e=>!o[e].optional));if(n.length)throw new Error(`Missing property '${n.map((e=>a+e)).join("', '")}' ${t.where}`)}for(const[r,l]of Object.entries(e)){if(!o.hasOwnProperty(r)){if(t.allowAdditionalProperties)continue;throw new Error(`Unsupported property '${a+r}' ${t.where}`)}const e=o[r],s=e?.type||e,c=i(l);if(e.hasOwnProperty?.("value")){const n=e.value;switch(typeof n){case"function":{const e=n(l);if("string"==typeof e)throw new Error(e);break}default:if(l!==n)throw new Error(`The property '${a+r}' ${t.where} doesn't evaluate to "${e.value}"`)}}else if(e.hasOwnProperty?.("subschema")){if("object"!==c.toLowerCase())throw new TypeError(`The property '${a+r}' ${t.where} must be of type Object`);n(l,{...e.subschema,where:t.where},e.subschema.properties||e.subschema,`${a}${r}.`)}else{if(!Array.isArray(s))throw new SyntaxError("Invalid schema");if("array"===c){const e=s.filter((e=>Array.isArray(e)));let n=!1;for(let t of e)if(t=t.map((e=>e.toLowerCase())),n=l.every((e=>t.includes(i(e).toLowerCase()))),n)break;if(!n)throw new TypeError(`The array '${a+r}' ${t.where} contains one or more unsupported element types`)}else if(!s.filter((e=>"string"==typeof e)).map((e=>e.toLowerCase())).includes(c.toLowerCase()))throw new TypeError(`The property '${a+r}' ${t.where} is of unsupported type ${c}`)}}function i(e){return null===e?"null":Array.isArray(e)?"array":"string"==typeof e?.$constructor?e.$constructor:"function"==typeof e?.constructor?e.constructor.name:typeof e}},o={arguments:{where:"in arguments passed to matrix()",properties:{data:{type:[["number"]],value(e){if(16!==e.length)return"Matrices must be 4 x 4"}}}},interface:{where:"in the return value of matrix()",properties:{$constructor:{value:"Matrix"},data:{type:[["number"]],value(e){if(16!==e.length)return"Matrices must be 4 x 4"}}}}};function a(...e){e.length||e.push(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),n?.({data:e},o.arguments);const t={$constructor:"Matrix",data:e};return n?.(t,o.interface),t}function i(e=a(),t=a()){let r=a();for(let n=0;n<4;n++)for(let o=0;o<16;o+=4)r.data[n+o]=e.data[n]*t.data[o]+e.data[n+4]*t.data[o+1]+e.data[n+8]*t.data[o+2]+e.data[n+12]*t.data[o+3];return r}a.scaling=function(e=0,t=0,r=0){return a(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1)},a.translation=function(e=0,t=0,r=0){return a(1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1)},a.rotation=function(e=0,t=0,r=0){const n=Math.PI/180;e*=n,t*=n,r*=n;const o=Math.sin(e),l=Math.cos(e),s=Math.sin(t),c=Math.cos(t),f=Math.sin(r),u=Math.cos(r);return i(a(1,0,0,0,0,l,-o,0,0,o,l,0,0,0,0,1),i(a(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),a(u,-f,0,0,f,u,0,0,0,0,1,0,0,0,0,1)))};const l={arguments:{where:"in arguments passed to vertex()",properties:{x:["number"],y:["number"],z:["number"],u:["number"],v:["number"],w:["number"],shade:["number"],worldX:["number"],worldY:["number"],worldZ:["number"]}},interface:{where:"in the return value of vertex()",properties:{$constructor:{value:"Vertex"},x:["number"],y:["number"],z:["number"],u:["number"],v:["number"],w:["number"],shade:["number"],worldX:["number"],worldY:["number"],worldZ:["number"]}}};function s(e=0,t=0,r=0,o=0,a=0,i=1,s=1,c=e,f=t,u=r){n?.({x:e,y:t,z:r,u:o,v:a,w:i,shade:s,worldX:c,worldY:f,worldZ:u},l.arguments);const d={$constructor:"Vertex",x:e,y:t,z:r,u:o,v:a,w:i,shade:s,worldX:c,worldY:f,worldZ:u};return n?.(d,l.interface),d}s.transform=function(e=s(),t=a()){const r=t.data[0]*e.x+t.data[4]*e.y+t.data[8]*e.z+t.data[12]*e.w,n=t.data[1]*e.x+t.data[5]*e.y+t.data[9]*e.z+t.data[13]*e.w,o=t.data[2]*e.x+t.data[6]*e.y+t.data[10]*e.z+t.data[14]*e.w,i=t.data[3]*e.x+t.data[7]*e.y+t.data[11]*e.z+t.data[15]*e.w;e.x=r,e.y=n,e.z=o,e.w=i};const c={interface:{where:"in the return value of vector()",properties:{$constructor:{value:"Vector"},x:["number"],y:["number"],z:["number"]}},arguments:{where:"in arguments passed to vector()",properties:{x:["number"],y:["number"],z:["number"]}}};function f(e=0,t=0,r=0){n?.({x:e,y:t,z:r},c.arguments);const o={$constructor:"Vector",x:e,y:t,z:r};return n?.(o,c.interface),o}f.transform=function(e=f(),t=Matrix()){const r=t.data[0]*e.x+t.data[4]*e.y+t.data[8]*e.z,n=t.data[1]*e.x+t.data[5]*e.y+t.data[9]*e.z,o=t.data[2]*e.x+t.data[6]*e.y+t.data[10]*e.z;e.x=r,e.y=n,e.z=o},f.normalize=function(e=f()){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(0!=t&&1!=t){const r=1/Math.sqrt(t);e.x*=r,e.y*=r,e.z*=r}},f.dot=function(e=f(),t=f()){return e.x*t.x+e.y*t.y+e.z*t.z},f.cross=function(e=f(),t=f()){const r=f();return r.x=e.y*t.z-e.z*t.y,r.y=e.z*t.x-e.x*t.z,r.z=e.x*t.y-e.y*t.x,r},f.invert=function(e=vector()){e.x*=-1,e.y*=-1,e.z*=-1};const u={arguments:{where:"in arguments passed to color()",properties:{red:["number"],green:["number"],blue:["number"],alpha:["number"]}},interface:{where:"in the return value of color()",properties:{$constructor:{value:"Color"},red:["number"],green:["number"],blue:["number"],alpha:["number"],unitRange:{subschema:{red:["number"],green:["number"],blue:["number"],alpha:["number"]}}}}};function d(e=0,t=0,o=0,a=255){n?.({red:e,green:t,blue:o,alpha:a},u.arguments),r?.(e>=0&&e<=255&&t>=0&&t<=255&&o>=0&&o<=255&&a>=0&&a<=255,"One or more of the given color values are out of range.");const i={$constructor:"Color",red:e,green:t,blue:o,alpha:a,unitRange:{red:e/255,green:t/255,blue:o/255,alpha:a/255}};return n?.(i,u.interface),i}d.aliceblue=Object.freeze(d(240,248,255)),d.antiquewhite=Object.freeze(d(250,235,215)),d.aqua=Object.freeze(d(0,255,255)),d.aquamarine=Object.freeze(d(127,255,212)),d.azure=Object.freeze(d(240,255,255)),d.beige=Object.freeze(d(245,245,220)),d.bisque=Object.freeze(d(255,228,196)),d.black=Object.freeze(d(0,0,0)),d.blanchedalmond=Object.freeze(d(255,235,205)),d.blue=Object.freeze(d(0,0,255)),d.blueviolet=Object.freeze(d(138,43,226)),d.brown=Object.freeze(d(165,42,42)),d.burlywood=Object.freeze(d(222,184,135)),d.cadetblue=Object.freeze(d(95,158,160)),d.chartreuse=Object.freeze(d(127,255,0)),d.chocolate=Object.freeze(d(210,105,30)),d.coral=Object.freeze(d(255,127,80)),d.cornflowerblue=Object.freeze(d(100,149,237)),d.cornsilk=Object.freeze(d(255,248,220)),d.crimson=Object.freeze(d(220,20,60)),d.cyan=Object.freeze(d(0,255,255)),d.darkblue=Object.freeze(d(0,0,139)),d.darkcyan=Object.freeze(d(0,139,139)),d.darkgoldenrod=Object.freeze(d(184,134,11)),d.darkgray=Object.freeze(d(169,169,169)),d.darkgreen=Object.freeze(d(0,100,0)),d.darkgrey=Object.freeze(d(169,169,169)),d.darkkhaki=Object.freeze(d(189,183,107)),d.darkmagenta=Object.freeze(d(139,0,139)),d.darkolivegreen=Object.freeze(d(85,107,47)),d.darkorange=Object.freeze(d(255,140,0)),d.darkorchid=Object.freeze(d(153,50,204)),d.darkred=Object.freeze(d(139,0,0)),d.darksalmon=Object.freeze(d(233,150,122)),d.darkseagreen=Object.freeze(d(143,188,143)),d.darkslateblue=Object.freeze(d(72,61,139)),d.darkslategray=Object.freeze(d(47,79,79)),d.darkslategrey=Object.freeze(d(47,79,79)),d.darkturquoise=Object.freeze(d(0,206,209)),d.darkviolet=Object.freeze(d(148,0,211)),d.deeppink=Object.freeze(d(255,20,147)),d.deepskyblue=Object.freeze(d(0,191,255)),d.dimgray=Object.freeze(d(105,105,105)),d.dimgrey=Object.freeze(d(105,105,105)),d.dodgerblue=Object.freeze(d(30,144,255)),d.firebrick=Object.freeze(d(178,34,34)),d.floralwhite=Object.freeze(d(255,250,240)),d.forestgreen=Object.freeze(d(34,139,34)),d.fuchsia=Object.freeze(d(255,0,255)),d.gainsboro=Object.freeze(d(220,220,220)),d.ghostwhite=Object.freeze(d(248,248,255)),d.gold=Object.freeze(d(255,215,0)),d.goldenrod=Object.freeze(d(218,165,32)),d.gray=Object.freeze(d(128,128,128)),d.green=Object.freeze(d(0,128,0)),d.greenyellow=Object.freeze(d(173,255,47)),d.grey=Object.freeze(d(128,128,128)),d.honeydew=Object.freeze(d(240,255,240)),d.hotpink=Object.freeze(d(255,105,180)),d.indianred=Object.freeze(d(205,92,92)),d.indigo=Object.freeze(d(75,0,130)),d.ivory=Object.freeze(d(255,255,240)),d.khaki=Object.freeze(d(240,230,140)),d.lavender=Object.freeze(d(230,230,250)),d.lavenderblush=Object.freeze(d(255,240,245)),d.lawngreen=Object.freeze(d(124,252,0)),d.lemonchiffon=Object.freeze(d(255,250,205)),d.lightblue=Object.freeze(d(173,216,230)),d.lightcoral=Object.freeze(d(240,128,128)),d.lightcyan=Object.freeze(d(224,255,255)),d.lightgoldenrodyellow=Object.freeze(d(250,250,210)),d.lightgray=Object.freeze(d(211,211,211)),d.lightgreen=Object.freeze(d(144,238,144)),d.lightgrey=Object.freeze(d(211,211,211)),d.lightpink=Object.freeze(d(255,182,193)),d.lightsalmon=Object.freeze(d(255,160,122)),d.lightseagreen=Object.freeze(d(32,178,170)),d.lightskyblue=Object.freeze(d(135,206,250)),d.lightslategray=Object.freeze(d(119,136,153)),d.lightslategrey=Object.freeze(d(119,136,153)),d.lightsteelblue=Object.freeze(d(176,196,222)),d.lightyellow=Object.freeze(d(255,255,224)),d.lime=Object.freeze(d(0,255,0)),d.limegreen=Object.freeze(d(50,205,50)),d.linen=Object.freeze(d(250,240,230)),d.magenta=Object.freeze(d(255,0,255)),d.maroon=Object.freeze(d(128,0,0)),d.mediumaquamarine=Object.freeze(d(102,205,170)),d.mediumblue=Object.freeze(d(0,0,205)),d.mediumorchid=Object.freeze(d(186,85,211)),d.mediumpurple=Object.freeze(d(147,112,219)),d.mediumseagreen=Object.freeze(d(60,179,113)),d.mediumslateblue=Object.freeze(d(123,104,238)),d.mediumspringgreen=Object.freeze(d(0,250,154)),d.mediumturquoise=Object.freeze(d(72,209,204)),d.mediumvioletred=Object.freeze(d(199,21,133)),d.midnightblue=Object.freeze(d(25,25,112)),d.mintcream=Object.freeze(d(245,255,250)),d.mistyrose=Object.freeze(d(255,228,225)),d.moccasin=Object.freeze(d(255,228,181)),d.navajowhite=Object.freeze(d(255,222,173)),d.navy=Object.freeze(d(0,0,128)),d.oldlace=Object.freeze(d(253,245,230)),d.olive=Object.freeze(d(128,128,0)),d.olivedrab=Object.freeze(d(107,142,35)),d.orange=Object.freeze(d(255,165,0)),d.orangered=Object.freeze(d(255,69,0)),d.orchid=Object.freeze(d(218,112,214)),d.palegoldenrod=Object.freeze(d(238,232,170)),d.palegreen=Object.freeze(d(152,251,152)),d.paleturquoise=Object.freeze(d(175,238,238)),d.palevioletred=Object.freeze(d(219,112,147)),d.papayawhip=Object.freeze(d(255,239,213)),d.peachpuff=Object.freeze(d(255,218,185)),d.peru=Object.freeze(d(205,133,63)),d.pink=Object.freeze(d(255,192,203)),d.plum=Object.freeze(d(221,160,221)),d.powderblue=Object.freeze(d(176,224,230)),d.purple=Object.freeze(d(128,0,128)),d.red=Object.freeze(d(255,0,0)),d.rosybrown=Object.freeze(d(188,143,143)),d.royalblue=Object.freeze(d(65,105,225)),d.saddlebrown=Object.freeze(d(139,69,19)),d.salmon=Object.freeze(d(250,128,114)),d.sandybrown=Object.freeze(d(244,164,96)),d.seagreen=Object.freeze(d(46,139,87)),d.seashell=Object.freeze(d(255,245,238)),d.sienna=Object.freeze(d(160,82,45)),d.silver=Object.freeze(d(192,192,192)),d.skyblue=Object.freeze(d(135,206,235)),d.slateblue=Object.freeze(d(106,90,205)),d.slategray=Object.freeze(d(112,128,144)),d.slategrey=Object.freeze(d(112,128,144)),d.snow=Object.freeze(d(255,250,250)),d.springgreen=Object.freeze(d(0,255,127)),d.steelblue=Object.freeze(d(70,130,180)),d.tan=Object.freeze(d(210,180,140)),d.teal=Object.freeze(d(0,128,128)),d.thistle=Object.freeze(d(216,191,216)),d.tomato=Object.freeze(d(255,99,71)),d.turquoise=Object.freeze(d(64,224,208)),d.violet=Object.freeze(d(238,130,238)),d.wheat=Object.freeze(d(245,222,179)),d.white=Object.freeze(d(255,255,255)),d.whitesmoke=Object.freeze(d(245,245,245)),d.yellow=Object.freeze(d(255,255,0)),d.yellowgreen=Object.freeze(d(154,205,50));const h={color:d(255,255,255,255),wireframeColor:d(0,0,0,255),texture:void 0,textureMapping:"ortho",textureFiltering:"none",uvWrapping:"repeat",vertexShading:"none",renderVertexShade:!0,ambientLightLevel:0,hasWireframe:!1,hasFill:!0,isTwoSided:!1,isInScreenSpace:!1,allowAlphaReject:!1,allowAlphaBlend:!1},p={arguments:{where:"in arguments passed to ngon()",properties:{vertices:[["Vertex"]],material:["object"],vertexNormals:[["Vector"],"Vector"]}},interface:{where:"in the return value of ngon()",properties:{$constructor:{value:"Ngon"},vertices:[["Vertex"]],vertexNormals:[["Vector"]],normal:["Vector"],material:{subschema:{allowAdditionalProperties:!0,properties:{color:["Color"],wireframeColor:["Color"],texture:["undefined","null","Texture"],textureMapping:["string"],textureFiltering:["string"],uvWrapping:["string"],vertexShading:["string"],renderVertexShade:["boolean"],ambientLightLevel:["number"],hasWireframe:["boolean"],hasFill:["boolean"],isTwoSided:["boolean"],isInScreenSpace:["boolean"],allowAlphaReject:["boolean"],allowAlphaBlend:["boolean"]}}},mipLevel:["number"]}}};function m(e=[s()],t={},r=f(0,1,0)){for(const e of Object.keys(h))t.hasOwnProperty(e)||(t[e]=h[e]);n?.({vertices:e,material:t,vertexNormals:r},p.arguments),Array.isArray(r)||(r=new Array(e.length).fill().map((e=>f(r.x,r.y,r.z))));const o=r.reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e.z+=t.z,e)),f(0,0,0));f.normalize(o);{const t=e.map((e=>e.u)).some((e=>e<0)),r=e.map((e=>e.v)).some((e=>e<0));if(t||r)for(const n of e)t&&0===n.u&&(n.u=-Number.EPSILON),r&&0===n.v&&(n.v=-Number.EPSILON)}const a={$constructor:"Ngon",vertices:e,vertexNormals:r,normal:o,material:t,mipLevel:0};return n?.(a,p.interface),a}function g(e=m()){for(const t of e.vertices)t.x/=t.w,t.y/=t.w}function b(e=m(),t=a()){for(const r of e.vertices)s.transform(r,t)}const x=["x","y","z"],v=[1,-1];function w(e){for(const t of x)for(const r of v){if(!e.vertices.length)break;if(1==e.vertices.length){if(e.vertices[0].x<=e.vertices[0].w&&-e.vertices[0].x<=e.vertices[0].w&&e.vertices[0].y<=e.vertices[0].w&&-e.vertices[0].y<=e.vertices[0].w&&e.vertices[0].z<=e.vertices[0].w&&-e.vertices[0].z<=e.vertices[0].w)break;e.vertices.length=0;break}let n=e.vertices[e.vertices.length-(2==e.vertices.length?2:1)],o=n[t]*r,a=o<=n.w,i=0;const l=e.vertices.length;for(let c=0;c<l;c++){const f=e.vertices[c],u=f[t]*r,d=u<=f.w;if(d^a){const t=(n.w-o)/(n.w-o-(f.w-u));e.vertices[l+i++]=s(z(n.x,f.x,t),z(n.y,f.y,t),z(n.z,f.z,t),z(n.u,f.u,t),z(n.v,f.v,t),z(n.w,f.w,t),z(n.shade,f.shade,t),z(n.worldX,f.worldX,t),z(n.worldY,f.worldY,t),z(n.worldZ,f.worldZ,t))}d&&(e.vertices[l+i++]=f),n=f,o=u,a=d}e.vertices.splice(0,l)}}function z(e,t,r){return e+r*(t-e)}const y={enabled:[[[.25,0],[.5,.75]],[[.75,.5],[0,.25]]],disabled:[[[0,0],[0,0]],[[0,0],[0,0]]]};function j({renderState:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:a}){if(!o||!a)return!0;const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.useDepthBuffer?e.depthBuffer.data:null,u=e.pixelBuffer.width,d=t.material,h=d.texture||null,p=h&&"dither"===d.textureFiltering?y.enabled:y.disabled;let m=null,g=0;if(h){const e=h.mipLevels.length;g=Math.max(0,Math.min(e-1,Math.round((e-1)*t.mipLevel))),m=h.mipLevels[g]}let b=0,x=0,v=r[b],w=n[x];const z=r[0].top,j=r[o-1].bottom;let O=z-1;for(;++O<j;){const o=Math.min(u,Math.max(0,Math.round(v.x))),a=Math.min(u,Math.max(0,Math.ceil(w.x))),g=a-o+1;if(g>0){const r=i?1:v.invW,n=i?1:w.invW,b=i?(w.invW-v.invW)/g:0;let x=i?v.invW-b:1;const y=(w.depth/n-v.depth/r)/g;let M=v.depth/r-y;const B=(w.shade-v.shade)/g;let S=v.shade-B;const W=(w.u/n-v.u/r)/g;let k=v.u/r-W;const A=(w.v/n-v.v/r)/g;let P=v.v/r-A;const C=(w.worldX/n-v.worldX/r)/g;let E=v.worldX/r-C;const L=(w.worldY/n-v.worldY/r)/g;let V=v.worldY/r-L;const _=(w.worldZ/n-v.worldZ/r)/g;let $=v.worldZ/r-_,D=o+O*u-1,F=o-1;for(;++F<a;){let r=0,n=0;M+=y,S+=B,k+=W,P+=A,x+=b,E+=C,V+=L,$+=_,D++;const a=M/x;if(f&&f[D]<=a)continue;let i=d.renderVertexShade?S:1,u=0,v=0,w=0;if(h){switch(d.textureMapping){case"affine":switch(r=k/x,n=P/x,d.uvWrapping){case"clamp":{const e=1-Number.EPSILON;r=r<0?e+r:r,n=n<0?e+n:n;const t=p[1&O][1&F];r+=t[0]/m.width,n+=t[1]/m.height,r=m.width*(r<0?0:r>e?e:r),n=m.height*(n<0?0:n>e?e:n);break}case"repeat":{const e=p[1&O][1&F];r+=e[0]/m.width,n+=e[1]/m.height,r=m.width*(r-Math.floor(r)),n=m.height*(n-Math.floor(n));const t=Math.abs(r),o=Math.abs(n),a=t-~~t,i=o-~~o;r=(r&m.width-1)+a,n=(n&m.height-1)+i;break}default:throw new Error("Unrecognized UV wrapping mode.")}break;case"affine-npot":{r=k/x,n=P/x;const e=1-Number.EPSILON;r=r<0?e+r:r,n=n<0?e+n:n;const t=p[1&O][1&F];r+=t[0]/m.width,n+=t[1]/m.height,r=m.width*(r<0?0:r>e?e:r),n=m.height*(n<0?0:n>e?e:n)}break;case"ortho":{const e=j-z,t=F-o+1,a=O-z+1,i=p[1&O][1&F];r+=i[0],n+=i[1],r=t*(m.width/g),n=a*(m.height/e),n=m.height-n;break}default:throw new Error("Unknown texture-mapping mode.")}const e=4*(~~r+~~n*m.width);if(d.allowAlphaReject&&255!==m.pixels[e+3])continue;if(d.allowAlphaBlend&&N.stipple_test(d.color.alpha,F,O))continue;u=m.pixels[e+0],v=m.pixels[e+1],w=m.pixels[e+2]}else{if(d.allowAlphaBlend&&N.stipple_test(d.color.alpha,F,O))continue;u=d.color.red*i,v=d.color.green*i,w=d.color.blue*i}if(u*=i*d.color.unitRange.red,v*=i*d.color.unitRange.green,w*=i*d.color.unitRange.blue,i>1){const t=4*D;e.pixelBuffer8[t+0]=u,e.pixelBuffer8[t+1]=v,e.pixelBuffer8[t+2]=w,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[D]=(255<<24)+(w<<16)+(v<<8)+~~u;if(f&&(f[D]=a),l){const e=c[D];!s.ngon||(e.ngon=t),!s.textureUScaled||(e.textureUScaled=~~r),!s.textureVScaled||(e.textureVScaled=~~n),!s.shade||(e.shade=S),!s.worldX||(e.worldX=E/x),!s.worldY||(e.worldY=V/x),!s.worldZ||(e.worldZ=$/x)}}}v.x+=v.delta.x,v.depth+=v.delta.depth,v.shade+=v.delta.shade,v.u+=v.delta.u,v.v+=v.delta.v,v.invW+=v.delta.invW,v.worldX+=v.delta.worldX,v.worldY+=v.delta.worldY,v.worldZ+=v.delta.worldZ,w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.u+=w.delta.u,w.v+=w.delta.v,w.invW+=w.delta.invW,w.worldX+=w.delta.worldX,w.worldY+=w.delta.worldY,w.worldZ+=w.delta.worldZ,O===v.bottom-1&&(v=r[++b]),O===w.bottom-1&&(w=n[++x])}return!0}function O({renderState:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:a}){const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.pixelBuffer.width,u=e.useDepthBuffer?e.depthBuffer.data:null,d=t.material;let h=0,p=0,m=r[h],g=n[p];if(!o||!a)return;const b=r[0].top,x=r[o-1].bottom;let v=b-1;for(;++v<x;){const o=Math.min(f,Math.max(0,Math.round(m.x))),a=Math.min(f,Math.max(0,Math.ceil(g.x))),b=a-o+1;if(b>0){const r=i?1:m.invW,n=i?1:g.invW,h=i?(g.invW-m.invW)/b:0;let p=i?m.invW-h:1;const x=(g.depth/n-m.depth/r)/b;let w=m.depth/r-x;const z=(g.shade-m.shade)/b;let y=m.shade-z,j=o+v*f-1,O=o-1;for(;++O<a;){w+=x,y+=z,p+=h,j++;const r=w/p;if(!(u[j]<=r)){const n=d.renderVertexShade?y:1,o=d.color.red*n,a=d.color.green*n,i=d.color.blue*n;if(n>1){const t=4*j;e.pixelBuffer8[t+0]=o,e.pixelBuffer8[t+1]=a,e.pixelBuffer8[t+2]=i,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[j]=(255<<24)+(i<<16)+(a<<8)+~~o;if(u[j]=r,l){const e=c[j];!s.ngon||(e.ngon=t),!s.shade||(e.shade=y)}}}}m.x+=m.delta.x,m.depth+=m.delta.depth,m.shade+=m.delta.shade,m.invW+=m.delta.invW,g.x+=g.delta.x,g.depth+=g.delta.depth,g.shade+=g.delta.shade,g.invW+=g.delta.invW,v===m.bottom-1&&(m=r[++h]),v===g.bottom-1&&(g=n[++p])}return!0}function M({renderState:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:a}){if(!o||!a)return!0;const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.pixelBuffer.width,u=e.useDepthBuffer?e.depthBuffer.data:null,d=t.material,h=d.texture||null;let p=null,m=0;const g=h.mipLevels.length;m=Math.max(0,Math.min(g-1,Math.round((g-1)*t.mipLevel))),p=h.mipLevels[m];let b=0,x=0,v=r[b],w=n[x];const z=r[0].top,y=r[o-1].bottom;let j=z-1;for(;++j<y;){const o=Math.min(f,Math.max(0,Math.round(v.x))),a=Math.min(f,Math.max(0,Math.ceil(w.x))),h=a-o+1;if(h>0){const r=i?1:v.invW,n=i?1:w.invW,m=i?(w.invW-v.invW)/h:0;let g=i?v.invW-m:1;const b=(w.depth/n-v.depth/r)/h;let x=v.depth/r-b;const z=(w.shade-v.shade)/h;let y=v.shade-z;const O=(w.u/n-v.u/r)/h;let M=v.u/r-O;const B=(w.v/n-v.v/r)/h;let S=v.v/r-B,W=o+j*f-1,k=o-1;for(;++k<a;){x+=b,y+=z,M+=O,S+=B,g+=m,W++;const r=x/g;if(u[W]<=r)continue;let n=M/g,o=S/g;switch(d.uvWrapping){case"clamp":{const e=1-Number.EPSILON;n=n<0?e+n:n,o=o<0?e+o:o,n=p.width*(n<0?0:n>e?e:n),o=p.height*(o<0?0:o>e?e:o);break}case"repeat":n=p.width*(n-Math.floor(n)),o=p.height*(o-Math.floor(o)),n&=p.width-1,o&=p.height-1;break;default:throw new Error("Unrecognized UV wrapping mode.")}const a=4*(~~n+~~o*p.width);{const i=d.renderVertexShade?y:1,f=p.pixels[a+0]*i,h=p.pixels[a+1]*i,m=p.pixels[a+2]*i;if(i>1){const t=4*W;e.pixelBuffer8[t+0]=f,e.pixelBuffer8[t+1]=h,e.pixelBuffer8[t+2]=m,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[W]=(255<<24)+(m<<16)+(h<<8)+~~f;if(u[W]=r,l){const e=c[W];!s.ngon||(e.ngon=t),!s.textureUScaled||(e.textureUScaled=~~n),!s.textureVScaled||(e.textureVScaled=~~o),!s.shade||(e.shade=y)}}}}v.x+=v.delta.x,v.depth+=v.delta.depth,v.shade+=v.delta.shade,v.u+=v.delta.u,v.v+=v.delta.v,v.invW+=v.delta.invW,w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.u+=w.delta.u,w.v+=w.delta.v,w.invW+=w.delta.invW,j===v.bottom-1&&(v=r[++b]),j===w.bottom-1&&(w=n[++x])}return!0}function B({renderState:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:a}){if(!o||!a)return!0;const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.pixelBuffer.width,u=e.useDepthBuffer?e.depthBuffer.data:null,d=t.material,h=d.texture||null;let p=null,m=0;const g=h.mipLevels.length;m=Math.max(0,Math.min(g-1,Math.round((g-1)*t.mipLevel))),p=h.mipLevels[m];let b=0,x=0,v=r[b],w=n[x];const z=r[0].top,y=r[o-1].bottom;let j=z-1;for(;++j<y;){const o=Math.min(f,Math.max(0,Math.round(v.x))),a=Math.min(f,Math.max(0,Math.ceil(w.x))),h=a-o+1;if(h>0){const r=i?1:v.invW,n=i?1:w.invW,m=i?(w.invW-v.invW)/h:0;let g=i?v.invW-m:1;const b=(w.depth/n-v.depth/r)/h;let x=v.depth/r-b;const z=(w.shade-v.shade)/h;let y=v.shade-z;const O=(w.u/n-v.u/r)/h;let M=v.u/r-O;const B=(w.v/n-v.v/r)/h;let S=v.v/r-B,W=o+j*f-1,k=o-1;for(;++k<a;){x+=b,y+=z,M+=O,S+=B,g+=m,W++;const r=x/g;if(u[W]<=r)continue;let n=M/g,o=S/g;switch(d.uvWrapping){case"clamp":{const e=1-Number.EPSILON;n=n<0?e+n:n,o=o<0?e+o:o,n=p.width*(n<0?0:n>e?e:n),o=p.height*(o<0?0:o>e?e:o);break}case"repeat":{n=p.width*(n-Math.floor(n)),o=p.height*(o-Math.floor(o));const e=Math.abs(n),t=Math.abs(o),r=e-~~e,a=t-~~t;n=(n&p.width-1)+r,o=(o&p.height-1)+a;break}default:throw new Error("Unrecognized UV wrapping mode.")}const a=4*(~~n+~~o*p.width);{const i=d.renderVertexShade?y:1,f=p.pixels[a+0]*i*d.color.unitRange.red,h=p.pixels[a+1]*i*d.color.unitRange.green,m=p.pixels[a+2]*i*d.color.unitRange.blue;if(i>1){const t=4*W;e.pixelBuffer8[t+0]=f,e.pixelBuffer8[t+1]=h,e.pixelBuffer8[t+2]=m,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[W]=(255<<24)+(m<<16)+(h<<8)+~~f;if(u[W]=r,l){const e=c[W];!s.ngon||(e.ngon=t),!s.textureUScaled||(e.textureUScaled=~~n),!s.textureVScaled||(e.textureVScaled=~~o),!s.shade||(e.shade=y)}}}}v.x+=v.delta.x,v.depth+=v.delta.depth,v.shade+=v.delta.shade,v.u+=v.delta.u,v.v+=v.delta.v,v.invW+=v.delta.invW,w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.u+=w.delta.u,w.v+=w.delta.v,w.invW+=w.delta.invW,j===v.bottom-1&&(v=r[++b]),j===w.bottom-1&&(w=n[++x])}return!0}function S(e,t=s(),r=s(),n=d(),o=!0){const a=e.useDepthBuffer?e.depthBuffer.data:null,i=e.pixelBuffer.width,l=e.pixelBuffer.height,c=Math.floor(t.x),f=Math.floor(t.y),u=Math.floor(r.x),h=Math.ceil(r.y);let p=Math.ceil(Math.sqrt((u-c)**2+(h-f)**2));const m=(u-c)/p,g=(h-f)/p,b=t.z/e.farPlaneDistance,x=(r.z/e.farPlaneDistance-b)/p,v=o?t.shade:1,w=((o?r.shade:1)-v)/p;let z=c,y=f,j=b,O=v;for(;p--;){const t=~~z,r=~~y,o=t+r*i;if(t>=0&&r>=0&&t<i&&r<l&&(!a||a[o]>j)){const t=n.red*O,r=n.green*O,i=n.blue*O;if(O>1){const n=4*o;e.pixelBuffer8[n+0]=t,e.pixelBuffer8[n+1]=r,e.pixelBuffer8[n+2]=i,e.pixelBuffer8[n+3]=255}else e.pixelBuffer32[o]=(255<<24)+(i<<16)+(r<<8)+~~t;a&&(a[o]=j)}z+=m,y+=g,j+=x,O+=w}return!0}function W(e,t=s(),r=s(),n=d()){const o=e.pixelBuffer.width,a=e.pixelBuffer.height,i=Math.floor(t.x),l=Math.floor(t.y),c=Math.floor(r.x),f=Math.ceil(r.y);let u=Math.ceil(Math.sqrt((c-i)**2+(f-l)**2));const h=(c-i)/u,p=(f-l)/u,m=(255<<24)+(n.blue<<16)+(n.green<<8)+~~n.red;let g=i,b=l;for(;u--;){const t=~~g,r=~~b;if(t>=0&&r>=0&&t<o&&r<a){const n=t+r*o;e.pixelBuffer32[n]=m}g+=h,b+=p}return!0}function k(e,t=s(),r=d()){const n=e.useDepthBuffer?e.depthBuffer.data:null,o=e.pixelBuffer.width,a=Math.floor(t.x)+Math.floor(t.y)*o,i=t.z/e.farPlaneDistance;if(!(n&&n[a]<=i)){{const o=t.shade,l=r.red*o,s=r.green*o,c=r.blue*o;if(o>1){const t=4*a;e.pixelBuffer8[t+0]=l,e.pixelBuffer8[t+1]=s,e.pixelBuffer8[t+2]=c,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[a]=(255<<24)+(c<<16)+(s<<8)+~~l;n&&(n[a]=i)}return!0}}function A(e,t=s(),r=d()){return e.pixelBuffer32[Math.floor(t.x)+Math.floor(t.y)*e.pixelBuffer.width]=(255<<24)+(r.blue<<16)+(r.green<<8)+~~r.red,!0}const P=500,C=new Array(P),E=new Array(P),L=new Array(P).fill().map((()=>({top:void 0,bottom:void 0,start:{},delta:{}}))),V=new Array(P).fill().map((()=>({top:void 0,bottom:void 0,start:{},delta:{}}))),_=(e,t)=>e.y===t.y?0:e.y<t.y?-1:1;function N(e){for(let t=0;t<e.ngonCache.count;t++){const n=e.ngonCache.ngons[t];switch(r?.(n.vertices.length,"Encountered an n-gon with 0 vertices"),n.vertices.length){case 0:continue;case 1:N.point(e,n.vertices[0],n.material.color);break;case 2:N.line(e,n.vertices[0],n.vertices[1],n.material.color,n.material.renderVertexShade);break;default:N.polygon(e,n)}}}N.polygon=function(e,t=m()){r?.(t.vertices.length>=3,"Polygons must have 3 or more vertices"),r?.(t.vertices.length<P,"Overflowing the vertex buffer");const n=e.useFragmentBuffer,o=e.fragments,a=e.useDepthBuffer?e.depthBuffer.data:null,i=e.pixelBuffer.width,l=e.pixelBuffer.height,s=t.material;let c=0,f=0,u=0,d=0;if(function(){t.vertices.sort(_);const e=t.vertices[0],r=t.vertices[t.vertices.length-1];C[c++]=e,E[f++]=e;for(let a=1;a<t.vertices.length-1;a++){const i=(n=e.x,o=r.x,n+(t.vertices[a].y-e.y)/(r.y-e.y)*(o-n));t.vertices[a].x>=i?E[f++]=t.vertices[a]:C[c++]=t.vertices[a]}var n,o;C[c++]=r,E[f++]=r}(),function(){for(let e=1;e<c;e++)t(C[e-1],C[e],!0);for(let e=1;e<f;e++)t(E[e-1],E[e],!1);function t(t,r,o){const a=Math.min(l,Math.max(0,Math.floor(t.y))),c=Math.min(l,Math.max(0,Math.floor(r.y))),f=c-a;if(0===f)return;const h=t.w,p=r.w,m=Math.min(i,Math.max(0,Math.floor(t.x))),g=(Math.min(i,Math.max(0,Math.floor(r.x)))-m)/f,b=t.z/e.farPlaneDistance/h,x=(r.z/e.farPlaneDistance/p-b)/f,v=t.shade,w=(r.shade-v)/f,z=s.texture?t.u:1,y=s.texture?1-t.v:1,j=z/h,O=((s.texture?r.u:1)/p-j)/f,M=y/h,B=((s.texture?1-r.v:1)/p-M)/f,S=1/h,W=(1/p-S)/f,k=o?L[u++]:V[d++];k.top=a,k.bottom=c,k.x=m,k.delta.x=g,k.depth=b,k.delta.depth=x,k.shade=v,k.delta.shade=w,k.u=j,k.delta.u=O,k.v=M,k.delta.v=B,k.invW=S,k.delta.invW=W,n&&(k.worldX=t.worldX/h,k.delta.worldX=(r.worldX/p-t.worldX/h)/f,k.worldY=t.worldY/h,k.delta.worldY=(r.worldY/p-t.worldY/h)/f,k.worldZ=t.worldZ/h,k.delta.worldZ=(r.worldZ/p-t.worldZ/h)/f)}}(),s.hasFill){let r=j;!s.texture||!a||o.worldX||o.worldY||o.worldZ||s.allowAlphaReject||s.allowAlphaBlend||"affine"!==s.textureMapping||"dither"===s.textureFiltering?s.texture||!a||o.worldX||o.worldY||o.worldZ||s.allowAlphaReject||s.allowAlphaBlend||(r=O):r=255===s.color.red&&255===s.color.green&&255===s.color.blue&&"none"===s.textureFiltering?M:B,r({renderState:e,ngon:t,leftEdges:L,rightEdges:V,numLeftEdges:u,numRightEdges:d})}if(e.showGlobalWireframe||s.hasWireframe){for(let t=1;t<c;t++)N.line(e,C[t-1],C[t],s.wireframeColor,s.renderVertexShade);for(let t=1;t<f;t++)N.line(e,E[t-1],E[t],s.wireframeColor,s.renderVertexShade)}},N.line=function(e,t=s(),r=s(),n=d(),o=!0){if(255!==n.alpha)return;const a=e.pixelBuffer.width,i=e.pixelBuffer.height;if(!(t.x<0&&r.x<0||t.x>=a&&r.x>=a||t.y<0&&r.y<0||t.y>=i&&r.y<i)){let a=S;e.useDepthBuffer||o&&(1!==t.shade||1!==r.shade)||(a=W),a(e,t,r,n,o)}},N.point=function(e,t=s(),r=d()){if(255!=r.alpha)return;const n=e.pixelBuffer.width,o=e.pixelBuffer.height;if(!(t.x<0||t.y<0||t.x>=n||t.y>=o)){let n=k;e.useDepthBuffer||1!==t.shade||(n=A),n(e,t,r)}},N.stipple_test=function(){const e=[{width:8,height:6,pixels:[0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},{width:4,height:4,pixels:[0,1,0,1,1,1,1,1,1,0,1,0,1,1,1,1]},{width:2,height:2,pixels:[1,0,0,1]}];for(let t=e.length-2;t>=0;t--)e.push({width:e[t].width,height:e[t].height,pixels:e[t].pixels.map((e=>Number(!e)))});return function(t,r,n){if(t<=0)return!0;if(t>=255)return!1;{const o=Math.floor(t/(256/e.length)),a=e[o],i=r%a.width+n%a.height*a.width;if(a.pixels[i])return!0}return!1}}();const $={translate:f(0,0,0),rotate:f(0,0,0),scale:f(1,1,1)},D={where:"in arguments passed to mesh()",properties:{ngons:[["Ngon"]],transform:["object"]}},F={where:"in the return value of mesh()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Mesh"},ngons:[["Ngon"]],rotate:["Vector"],translate:["Vector"],scale:["Vector"]}};function I(e,t){r?.(["flat","gouraud"].includes(e.material.vertexShading),`Unrecognized shading mode: ${e.material.vertexShading}`);const n=f();let o=e.material.ambientLightLevel;for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=e.material.ambientLightLevel;let a=0,i=0,l=0;if("flat"===e.material.vertexShading){for(const t of e.vertices)a+=t.x,i+=t.y,l+=t.z;a/=e.vertices.length,i/=e.vertices.length,l/=e.vertices.length}for(const r of t.lights)if("gouraud"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++){const o=e.vertices[t],a=1/(1+Math.sqrt((o.x-r.position.x)*(o.x-r.position.x)+(o.y-r.position.y)*(o.y-r.position.y)+(o.z-r.position.z)*(o.z-r.position.z)));n.x=r.position.x-o.x,n.y=r.position.y-o.y,n.z=r.position.z-o.z,f.normalize(n);const i=e.vertices.length<3?1:f.dot(e.vertexNormals[t],n),l=Math.max(0,Math.min(1,i));o.shade=Math.max(o.shade,Math.min(1,l*a*r.intensity))}else if("flat"===e.material.vertexShading){const t=1/(1+Math.sqrt((a-r.position.x)*(a-r.position.x)+(i-r.position.y)*(i-r.position.y)+(l-r.position.z)*(l-r.position.z)));n.x=r.position.x-a,n.y=r.position.y-i,n.z=r.position.z-l,f.normalize(n);const s=e.vertices.length<3?1:f.dot(e.normal,n),c=Math.max(0,Math.min(1,s));o=Math.max(o,Math.min(1,c*t*r.intensity))}if("flat"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=o}function U(e="default"){return U[e]||(U[e]=T())}function T(){return{modules:{ngon_sorter:void 0,transform_clip_lighter:void 0,surface_wiper:void 0,rasterizer:void 0,vertex_shader:void 0,pixel_shader:void 0,context_shader:void 0},pixelBuffer:void 0,pixelBuffer8:void 0,pixelBuffer32:void 0,useDepthBuffer:!1,depthBuffer:{width:0,height:0,data:void 0,resize(e,t){this.width=e,this.height=t,this.data=new Float64Array(e*t)},clear(){this.data.fill(1)}},useFragmentBuffer:!1,fragmentBuffer:{width:0,height:0,data:void 0,resize(e,t){this.width=e,this.height=t,this.data=new Array(e*t).fill().map((e=>({})))}},fragments:{ngon:!0,textureUScaled:!0,textureVScaled:!0,shade:!0,worldX:!0,worldY:!0,worldZ:!0},usePixelShader:!1,pixel_shader:void 0,useVertexShader:!1,vertex_shader:void 0,useContextShader:!1,context_shader:void 0,offscreenRenderWidth:void 0,offscreenRenderHeight:void 0,renderScale:void 0,useFullInterpolation:!0,showGlobalWireframe:!1,nearPlaneDistance:1,farPlaneDistance:1,fov:45,cameraDirection:void 0,cameraPosition:void 0,allowWindowAlert:!1,ngonCache:{count:0,ngons:[]},vertexCache:{count:0,vertices:[]},vertexNormalCache:{count:0,normals:[]},lights:[]}}U.default=T();const R={cameraPosition:f(0,0,0),cameraDirection:f(0,0,0),state:"default",resolution:1,fov:43,nearPlane:1,farPlane:1e3,useDepthBuffer:!0,useFragmentBuffer:!1,fragments:void 0,useFullInterpolation:!0,globalWireframe:!1,hibernateWhenTargetNotVisible:!0,lights:[]},X={ngonSorter:void 0,surfaceWiper:function(e){e.pixelBuffer.data.fill(0),e.useDepthBuffer&&e.depthBuffer.clear()},rasterizer:N,transformClipLighter:function({renderState:e,mesh:t,cameraMatrix:r,perspectiveMatrix:n,screenSpaceMatrix:o}={}){const l={x:0,y:0,z:0},s=e.ngonCache,c=e.vertexCache,u=e.vertexNormalCache,d=i(n,r),h=function(e){const t=a.translation(e.translate.x,e.translate.y,e.translate.z),r=a.rotation(e.rotate.x,e.rotate.y,e.rotate.z),n=a.scaling(e.scale.x,e.scale.y,e.scale.z);return i(i(t,r),n)}(t);for(const r of t.ngons){if(!r.material.hasWireframe&&r.material.allowAlphaReject&&r.material.color.alpha<=0)continue;const t=s.ngons[s.count++];t.vertices.length=0;for(let e=0;e<r.vertices.length;e++){const n=r.vertices[e],o=t.vertices[e]=c.vertices[c.count++];o.x=n.x,o.y=n.y,o.z=n.z,o.u=n.u,o.v=n.v,o.w=n.w,o.shade=n.shade,t.vertexNormals[e]=u.normals[u.count++],t.vertexNormals[e].x=r.vertexNormals[e].x,t.vertexNormals[e].y=r.vertexNormals[e].y,t.vertexNormals[e].z=r.vertexNormals[e].z}if(t.material=r.material,t.normal.x=r.normal.x,t.normal.y=r.normal.y,t.normal.z=r.normal.z,t.isActive=!0,t.mipLevel=r.mipLevel,!t.material.isInScreenSpace){if(b(t,h),e.useFragmentBuffer)for(let e=0;e<t.vertices.length;e++)t.vertices[e].worldX=t.vertices[e].x,t.vertices[e].worldY=t.vertices[e].y,t.vertices[e].worldZ=t.vertices[e].z;for(let e=0;e<t.vertices.length;e++)f.transform(t.vertexNormals[e],h),f.normalize(t.vertexNormals[e]);if(f.transform(t.normal,h),f.normalize(t.normal),!t.material.isTwoSided&&t.vertices.length>2&&(l.x=t.vertices[0].x-e.cameraPosition.x,l.y=t.vertices[0].y-e.cameraPosition.y,l.z=t.vertices[0].z-e.cameraPosition.z,f.dot(t.normal,l)>=0)){t.isActive=!1,s.count--;continue}if("none"!==t.material.vertexShading&&I(t,e),e.useVertexShader&&e.modules.vertex_shader(t,e),b(t,d),w(t),!t.vertices.length){s.count--;continue}b(t,o),g(t)}}for(let e=s.count;e<s.ngons.length;e++)s.ngons[e].isActive=!1},pixelShader:void 0,vertexShader:void 0,contextShader:void 0},Y={where:"in arguments passed to render()",properties:{target:["HTMLCanvasElement","string","null"],meshes:[["Mesh"]],options:["object"],pipeline:["object"]}},Z={where:"in render({options})",properties:{cameraPosition:["Vector"],cameraDirection:["Vector"],state:["string","number"],resolution:["number","object"],fov:["number"],nearPlane:["number"],farPlane:["number"],useDepthBuffer:["boolean"],useFragmentBuffer:["boolean"],fragments:["object","undefined"],useFullInterpolation:["boolean"],globalWireframe:["boolean"],hibernateWhenTargetNotVisible:["boolean"],lights:[["Light","object"]]}},q={where:"in render({pipeline})",properties:{ngonSorter:["undefined","null","function"],surfaceWiper:["undefined","null","function"],rasterizer:["undefined","null","function"],transformClipLighter:["undefined","null","function"],pixelShader:["undefined","function"],vertexShader:["undefined","function"],contextShader:["undefined","function"]}},H={where:"in arguments passed to light()",properties:{intensity:["number"],position:["Vector"],options:["object"]}},G={where:"in the return value of light()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Light"},intensity:["number"],position:["Vector"]}},J=4,K={width:1,height:1,pixels:[255,255,255,255],encoding:"none",channels:"rgba:8+8+8+8"},Q={arguments:{where:"in arguments passed to texture()",allowAdditionalProperties:!0,properties:{pixels:["Uint8ClampedArray",["number"],"string"],width:{type:["number"],value(e){if(e<1||e>32768)return"Texture width must be in the range [1, 32768]"}},height:{type:["number"],value(e){if(e<1||e>32768)return"Texture height must be in the range [1, 32768]"}},encoding:{type:["string"],value(e){const t=["none","base64"];if(!t.includes(e))return`Texture encoding must be one of ${t.join(", ")}`}},channels:{type:["string"],value(e){const t=["rgba:5+5+5+1","rgba:8+8+8+8"];if(!t.includes(e))return`Texture pixel layout must be one of ${t.join(", ")}`}}}},interface:{where:"in the return value of texture()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Texture"},width:["number"],height:["number"],pixels:["Uint8ClampedArray"],mipLevels:[["object","Texture"]]}}};function ee(e={}){e=structuredClone(e);for(const t of Object.keys(K))e.hasOwnProperty(t)||(e[t]=K[t]);n?.(e,Q.arguments),function(e){if("none"===e.encoding)e.pixels instanceof Uint8ClampedArray||(e.pixels=new Uint8ClampedArray(e.pixels));else if("base64"===e.encoding){const t=atob(e.pixels);switch(e.pixels=new Uint8ClampedArray(e.width*e.height*J),e.channels){case"rgba:8+8+8+8":r?.(t.length===e.width*e.height*J,"Unexpected data length for a Base64-encoded texture; expected 4 bytes per pixel.");for(let r=0;r<e.width*e.height*4;r++)e.pixels[r]=t.charCodeAt(r);break;case"rgba:5+5+5+1":{r?.(t.length===e.width*e.height*2,"Unexpected data length for a Base64-encoded texture; expected 2 bytes per pixel.");let n=0;for(let r=0;r<e.width*e.height*2;r+=2){const o=t.charCodeAt(r)+(t.charCodeAt(r+1)<<8);e.pixels[n++]=8*(31&o),e.pixels[n++]=8*(o>>5&31),e.pixels[n++]=8*(o>>10&31),e.pixels[n++]=255*(o>>15&1)}break}default:throw new Error("Unrecognized value for texture 'channels' attribute.")}}else if("none"!==e.encoding)throw new Error("Unknown texture data encoding '"+e.encoding+"'.");r?.(e.pixels instanceof Uint8ClampedArray,"Expected texture data to be output as a Uint8ClampedArray."),r?.(e.pixels.length===e.width*e.height*J,"The texture's pixel array size doesn't match its width and height.")}(e);const t={$constructor:"Texture",refresh:te,...e};return t.refresh(),n?.(t,Q.interface),t}function te(){if(r?.(this.hasOwnProperty("$constructor")&&"Texture"===this.$constructor,"Expected 'this' to point to a Texture"),this.mipLevels=[this],1!==this.width||1!==this.height)for(let e=1;;e++){const t=Math.max(1,Math.floor(this.width/Math.pow(2,e))),n=Math.max(1,Math.floor(this.height/Math.pow(2,e))),o=[];{const e=this.width/t,r=this.height/n;for(let a=0;a<n;a++)for(let n=0;n<t;n++){const i=(n+a*t)*J,l=(Math.floor(n*e)+Math.floor(a*r)*this.width)*J;for(let e=0;e<J;e++)o[i+e]=this.pixels[l+e]}}if(this.mipLevels.push({width:t,height:n,pixels:o}),1===t&&1===n){r?.(this.mipLevels.length>0,"Failed to generate mip levels for a texture.");break}}}ee.load=async function(e){try{const t=await fetch(e);return ee(await t.json())}catch(t){throw new Error(`Failed to create a texture with data from file '${e}'. ${t}`)}};const re={version:{major:0,minor:4,isProductionBuild:!0},default:{render:{options:R,pipeline:X},mesh:{transform:$},texture:K,ngon:{material:h}},render:function({target:e=null,meshes:t,options:o={},pipeline:l={}}={}){n?.({target:e,meshes:t,options:o,pipeline:l},Y);const c={renderWidth:0,renderHeight:0,numNgonsRendered:0,totalRenderTimeMs:performance.now()};o=Object.freeze({...R,...o});for(const e of Object.keys(X))void 0===l[e]&&(l[e]=X[e]);n?.(o,Z),n?.(l,q),null===e&&r?.("object"==typeof o.resolution&&"number"==typeof o.resolution.width&&"number"==typeof o.resolution.height,"Undefined render resolution. Off-screen rendering requires `options.resolution` to be an object of the form {width, height}.");const u=function(e={},t={}){const r=U(e.state);if(r.useDepthBuffer=Boolean(e.useDepthBuffer),r.showGlobalWireframe=Boolean(e.globalWireframe),r.lights=e.lights,r.renderScale="number"==typeof e.resolution?e.resolution:void 0,r.renderWidth=e.resolution.width,r.renderHeight=e.resolution.height,r.nearPlaneDistance=e.nearPlane,r.farPlaneDistance=e.farPlane,r.fov=e.fov,r.cameraDirection=e.cameraDirection,r.cameraPosition=e.cameraPosition,r.useFullInterpolation=Boolean(e.useFullInterpolation),r.useFragmentBuffer=Boolean(e.useFragmentBuffer||r.usePixelShader&&r.pixel_shader?.toString().match(/{(.+)?}/)[1].includes("fragmentBuffer")),"object"==typeof e.fragments)for(const t of Object.keys(r.fragments))r.fragments[t]=e.fragments[t]??!1;else for(const e of Object.keys(r.fragments))r.fragments[e]=r.useFragmentBuffer;return r.modules.ngon_sorter=t.ngonSorter,r.modules.rasterizer=t.rasterizer,r.modules.transform_clip_lighter=t.transformClipLighter,r.modules.surface_wiper=t.surfaceWiper,r.usePixelShader=Boolean(t.pixelShader),r.modules.pixel_shader=t.pixelShader,r.useVertexShader=Boolean(t.vertexShader),r.modules.vertex_shader=t.vertexShader,r.useContextShader=Boolean(t.contextShader),r.modules.context_shader=t.contextShader,r}(o,l);"string"==typeof e&&(e=document.getElementById(e)),r?.(null===e||e instanceof HTMLCanvasElement,"Invalid canvas element for rendering into.");{const n=function(e,t){const n=null===e;let o,l,c;try{({surfaceWidth:o,surfaceHeight:l,canvasElement:e,renderContext:c}=n?function(e){return{surfaceWidth:e.renderWidth,surfaceHeight:e.renderHeight,renderContext:{createImageData:function(e,t){return new ImageData(e,t)}}}}(t):function(e,t){const n=t?.getContext("2d");let o,a;return r?.(t instanceof Element&&n,"Invalid canvas element"),"number"==typeof e.renderScale?(o=Math.floor(parseInt(window.getComputedStyle(t).getPropertyValue("width"))*e.renderScale),a=Math.floor(parseInt(window.getComputedStyle(t).getPropertyValue("height"))*e.renderScale),r?.(o>0&&a>0,"Failed to query the dimensions of the target canvas")):(r?.("number"==typeof e.renderWidth&&"number"==typeof e.renderHeight,"Invalid render resolution"),o=e.renderWidth,a=e.renderHeight),t.setAttribute("width",o),t.setAttribute("height",a),{surfaceWidth:o,surfaceHeight:a,canvasElement:t,renderContext:n}}(t,e)),function(e,t,r,n){void 0!==e.pixelBuffer&&e.pixelBuffer.width==r&&e.pixelBuffer.height==n||(e.pixelBuffer=t.createImageData(r,n),e.pixelBuffer8=new Uint8ClampedArray(e.pixelBuffer.data.buffer),e.pixelBuffer32=new Uint32Array(e.pixelBuffer.data.buffer)),!e.useFragmentBuffer||e.fragmentBuffer.width==r&&e.fragmentBuffer.height==n||e.fragmentBuffer.resize(r,n),!e.useDepthBuffer||e.depthBuffer.width==r&&e.depthBuffer.height==n&&e.depthBuffer.data.length||e.depthBuffer.resize(r,n)}(t,c,o,l)}catch(e){return console.error(e),null}const u=i(a.rotation(t.cameraDirection.x,t.cameraDirection.y,t.cameraDirection.z),a.translation(-t.cameraPosition.x,-t.cameraPosition.y,-t.cameraPosition.z)),d=function(e=0,t=0,r=0,n=0){const o=Math.tan(e/2),i=r-n;return a(1/(o*t),0,0,0,0,1/o,0,0,0,0,(-r-n)/i,1,0,0,2*n*(r/i),0)}(t.fov*(Math.PI/180),o/l,t.nearPlaneDistance,t.farPlaneDistance),h=function(e=0,t=0){const r=e/2,n=t/2;return a(r,0,0,0,0,-n,0,0,0,0,1,0,r-.5,n-.5,0,1)}(o+1,l+1),p={width:o,height:l,display_meshes:function(e=[]){if(t.modules.surface_wiper?.(t),e.length){if(function(e,t=[m()]){r?.(t instanceof Array,"Invalid arguments to n-gon cache initialization.");const n=e.vertexCache,o=e.vertexNormalCache;let a=0;for(const e of t)for(const t of e.ngons)a+=t.vertices.length;if(!n||!n.vertices.length||n.vertices.length<a){const e=a-n.vertices.length;n.vertices.push(...new Array(e).fill().map((e=>s())))}if(n.count=0,!o||!o.normals.length||o.normals.length<a){const e=a-o.normals.length;o.normals.push(...new Array(e).fill().map((e=>f())))}o.count=0}(t,e),function(e,t=[m()]){r?.(t instanceof Array,"Invalid arguments to n-gon cache initialization.");const n=e.ngonCache,o=t.reduce(((e,t)=>e+t.ngons.length),0);if(!n||!n.ngons.length||n.ngons.length<o){const e=o-n.ngons.length;n.ngons.push(...new Array(e).fill().map((e=>m())))}n.count=0}(t,e),t.modules.transform_clip_lighter)for(const r of e)t.modules.transform_clip_lighter({renderState:t,mesh:r,cameraMatrix:u,perspectiveMatrix:d,screenSpaceMatrix:h});"function"==typeof t.modules.ngon_sorter?t.modules.ngon_sorter(t.ngonCache.ngons):t.useDepthBuffer&&t.ngonCache.ngons.sort(((e,t)=>{const r=e.isActive?e.vertices.reduce(((e,t)=>e+t.z),0)/e.vertices.length:Number.MAX_VALUE,n=t.isActive?t.vertices.reduce(((e,t)=>e+t.z),0)/t.vertices.length:Number.MAX_VALUE;return r===n?0:r>n?1:-1})),function(e){for(let t=0;t<e.ngonCache.count;t++){const r=e.ngonCache.ngons[t];if(r.material.texture&&"affine"===r.material.textureMapping){let e=0==(r.material.texture.width&r.material.texture.width-1),t=0==(r.material.texture.height&r.material.texture.height-1);0===r.material.texture.width&&(e=!1),0===r.material.texture.height&&(t=!1),e&&t||(r.material.textureMapping="affine-npot")}}}(t),t.modules.rasterizer?.(t),t.usePixelShader&&t.modules.pixel_shader(t)}n||(t.useContextShader?t.modules.context_shader(c,t.pixelBuffer):c.putImageData(t.pixelBuffer,0,0))},is_in_view:function(){if(n)return!0;const t=window.innerHeight,r=e.getBoundingClientRect();return r.top>-r.height&&r.top<t}};return p}(e,u);c.renderWidth=n.width,c.renderHeight=n.height,!n||o.hibernateWhenTargetNotVisible&&!n.is_in_view()||(n.display_meshes(t),c.numNgonsRendered=u.ngonCache.count)}return c.totalRenderTimeMs=performance.now()-c.totalRenderTimeMs,c},color:d,state:U,light:function(e=100,t=f(0,0,0),r={}){n?.({intensity:e,position:t,options:r},H);const o={$constructor:"Light",...r,intensity:e,position:t};return n?.(o,G),o},mesh:function(e=[m()],t={}){n?.({ngons:e,transform:t},D);const r={$constructor:"Mesh",ngons:e,...$,...t};return n?.(r,F),r},matrix:a,ngon:m,texture:ee,vector:f,vertex:s};var ne=self;for(var oe in t)ne[oe]=t[oe];t.__esModule&&Object.defineProperty(ne,"__esModule",{value:!0})})();