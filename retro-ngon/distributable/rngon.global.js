(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Rngon:()=>te});const r="object"==typeof window?void 0:function(e,t){if(!e)throw new Error(t)},n="object"==typeof window?void 0:function(e,t,a=t.properties,o=""){r?.(e&&"object"==typeof e,"Schemas can't be evaluated for non-object types."),r?.(t&&"object"==typeof t&&a&&"object"==typeof a&&"string"==typeof o,"Malformed schema.");{const r=Object.keys(e),n=Object.keys(a).filter((e=>!r.includes(e))).filter((e=>!a[e].optional));if(n.length)throw new Error(`Missing property '${n.map((e=>o+e)).join("', '")}' ${t.where}.`)}for(const[r,l]of Object.entries(e)){if(!a.hasOwnProperty(r)){if(t.allowAdditionalProperties)continue;throw new Error(`Unsupported property '${o+r}' ${t.where}.`)}const e=a[r],s=e?.type||e,c=i(l);if(e.hasOwnProperty?.("value")){const n=e.value;switch(typeof n){case"function":{const e=n(l);if("string"==typeof e)throw new Error(e);break}default:if(l!==n)throw new Error(`The property '${o+r}' ${t.where} doesn't evaluate to "${e.value}".`)}}else if(e.hasOwnProperty?.("subschema")){if("object"!==c.toLowerCase())throw new TypeError(`The property '${o+r}' ${t.where} must be of type Object.`);n(l,{...e.subschema,where:t.where},e.subschema.properties||e.subschema,`${o}${r}.`)}else{if(!Array.isArray(s))throw new SyntaxError("Invalid schema");if("array"===c){const e=s.filter((e=>Array.isArray(e)));let n=!1;for(let t of e)if(t=t.map((e=>e.toLowerCase())),n=l.every((e=>t.includes(i(e).toLowerCase()))),n)break;if(!n)throw new TypeError(`The array '${o+r}' ${t.where} contains one or more unsupported element types.`)}else if(!s.filter((e=>"string"==typeof e)).map((e=>e.toLowerCase())).includes(c.toLowerCase()))throw new TypeError(`The property '${o+r}' ${t.where} is of unsupported type "${c}".`)}}function i(e){return null===e?"null":Array.isArray(e)?"array":"string"==typeof e?.$constructor?e.$constructor:"function"==typeof e?.constructor?e.constructor.name:typeof e}},a={arguments:{where:"in arguments to Rngon::matrix()",properties:{data:{type:[["number"]],value(e){if(16!==e.length)return"Matrices must be 4 x 4"}}}},interface:{where:"in the return value of Rngon::matrix()",properties:{$constructor:{value:"Matrix"},data:{type:[["number"]],value(e){if(16!==e.length)return"Matrices must be 4 x 4"}}}}};function o(...e){e.length||(e=o.identity().data),n?.({data:e},a.arguments);const t={$constructor:"Matrix",data:e};return n?.(t,a.interface),t}o.multiply=function(e=o(),t=o()){let r=o();for(let n=0;n<4;n++)for(let a=0;a<16;a+=4)r.data[n+a]=e.data[n]*t.data[a]+e.data[n+4]*t.data[a+1]+e.data[n+8]*t.data[a+2]+e.data[n+12]*t.data[a+3];return r},o.identity=function(){return o(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},o.scaling=function(e=0,t=0,r=0){return o(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1)},o.translating=function(e=0,t=0,r=0){return o(1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1)},o.rotating=function(e=0,t=0,r=0){const n=Math.PI/180;e*=n,t*=n,r*=n;const a=Math.sin(e),i=Math.cos(e),l=Math.sin(t),s=Math.cos(t),c=Math.sin(r),f=Math.cos(r),u=o(1,0,0,0,0,i,-a,0,0,a,i,0,0,0,0,1),d=o(s,0,l,0,0,1,0,0,-l,0,s,0,0,0,0,1),h=o(f,-c,0,0,c,f,0,0,0,0,1,0,0,0,0,1);return o.multiply(u,o.multiply(d,h))};const i={arguments:{where:"in arguments to Rngon::vertex()",properties:{x:["number"],y:["number"],z:["number"],u:["number"],v:["number"],w:["number"],shade:["number"],worldX:["number"],worldY:["number"],worldZ:["number"],normalX:["number"],normalY:["number"],normalZ:["number"]}},interface:{where:"in the return value of Rngon::vertex()",properties:{$constructor:{value:"Vertex"},x:["number"],y:["number"],z:["number"],u:["number"],v:["number"],w:["number"],shade:["number"],worldX:["number"],worldY:["number"],worldZ:["number"],normalX:["number"],normalY:["number"],normalZ:["number"]}}};function l(e=0,t=0,r=0,a=0,o=0,l=1,s=0,c=0,f=1,u=1,d=e,h=t,p=r){n?.({x:e,y:t,z:r,u:a,v:o,w:f,shade:u,worldX:d,worldY:h,worldZ:p,normalX:l,normalY:s,normalZ:c},i.arguments);const m={$constructor:"Vertex",x:e,y:t,z:r,u:a,v:o,w:f,shade:u,worldX:d,worldY:h,worldZ:p,normalX:l,normalY:s,normalZ:c};return n?.(m,i.interface),m}l.transform=function(e=l(),t=o()){const r=t.data[0]*e.x+t.data[4]*e.y+t.data[8]*e.z+t.data[12]*e.w,n=t.data[1]*e.x+t.data[5]*e.y+t.data[9]*e.z+t.data[13]*e.w,a=t.data[2]*e.x+t.data[6]*e.y+t.data[10]*e.z+t.data[14]*e.w,i=t.data[3]*e.x+t.data[7]*e.y+t.data[11]*e.z+t.data[15]*e.w;e.x=r,e.y=n,e.z=a,e.w=i};const s={interface:{where:"in the return value of Rngon::vector()",properties:{$constructor:{value:"Vector"},x:["number"],y:["number"],z:["number"]}},arguments:{where:"in arguments to Rngon::vector()",properties:{x:["number"],y:["number"],z:["number"]}}};function c(e=0,t=0,r=0){n?.({x:e,y:t,z:r},s.arguments);const a={$constructor:"Vector",x:e,y:t,z:r};return n?.(a,s.interface),a}c.transform=function(e=c(),t=Matrix()){const r=t.data[0]*e.x+t.data[4]*e.y+t.data[8]*e.z,n=t.data[1]*e.x+t.data[5]*e.y+t.data[9]*e.z,a=t.data[2]*e.x+t.data[6]*e.y+t.data[10]*e.z;e.x=r,e.y=n,e.z=a},c.normalize=function(e=c()){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(0!=t&&1!=t){const r=1/Math.sqrt(t);e.x*=r,e.y*=r,e.z*=r}},c.dot=function(e=c(),t=c()){return e.x*t.x+e.y*t.y+e.z*t.z},c.cross=function(e=c(),t=c()){const r=c();return r.x=e.y*t.z-e.z*t.y,r.y=e.z*t.x-e.x*t.z,r.z=e.x*t.y-e.y*t.x,r},c.invert=function(e=vector()){e.x*=-1,e.y*=-1,e.z*=-1};const f={arguments:{where:"in arguments to Rngon::color()",properties:{red:["number"],green:["number"],blue:["number"],alpha:["number"]}},interface:{where:"in the return value of Rngon::color()",properties:{$constructor:{value:"Color"},red:["number"],green:["number"],blue:["number"],alpha:["number"],unitRange:{subschema:{red:["number"],green:["number"],blue:["number"],alpha:["number"]}}}}};function u(e=0,t=0,a=0,o=255){n?.({red:e,green:t,blue:a,alpha:o},f.arguments),r?.(e>=0&&e<=255&&t>=0&&t<=255&&a>=0&&a<=255&&o>=0&&o<=255,"One or more of the given color values are out of range.");const i={$constructor:"Color",red:e,green:t,blue:a,alpha:o,unitRange:{red:e/255,green:t/255,blue:a/255,alpha:o/255}};return n?.(i,f.interface),i}u.aliceblue=Object.freeze(u(240,248,255)),u.antiquewhite=Object.freeze(u(250,235,215)),u.aqua=Object.freeze(u(0,255,255)),u.aquamarine=Object.freeze(u(127,255,212)),u.azure=Object.freeze(u(240,255,255)),u.beige=Object.freeze(u(245,245,220)),u.bisque=Object.freeze(u(255,228,196)),u.black=Object.freeze(u(0,0,0)),u.blanchedalmond=Object.freeze(u(255,235,205)),u.blue=Object.freeze(u(0,0,255)),u.blueviolet=Object.freeze(u(138,43,226)),u.brown=Object.freeze(u(165,42,42)),u.burlywood=Object.freeze(u(222,184,135)),u.cadetblue=Object.freeze(u(95,158,160)),u.chartreuse=Object.freeze(u(127,255,0)),u.chocolate=Object.freeze(u(210,105,30)),u.coral=Object.freeze(u(255,127,80)),u.cornflowerblue=Object.freeze(u(100,149,237)),u.cornsilk=Object.freeze(u(255,248,220)),u.crimson=Object.freeze(u(220,20,60)),u.cyan=Object.freeze(u(0,255,255)),u.darkblue=Object.freeze(u(0,0,139)),u.darkcyan=Object.freeze(u(0,139,139)),u.darkgoldenrod=Object.freeze(u(184,134,11)),u.darkgray=Object.freeze(u(169,169,169)),u.darkgreen=Object.freeze(u(0,100,0)),u.darkgrey=Object.freeze(u(169,169,169)),u.darkkhaki=Object.freeze(u(189,183,107)),u.darkmagenta=Object.freeze(u(139,0,139)),u.darkolivegreen=Object.freeze(u(85,107,47)),u.darkorange=Object.freeze(u(255,140,0)),u.darkorchid=Object.freeze(u(153,50,204)),u.darkred=Object.freeze(u(139,0,0)),u.darksalmon=Object.freeze(u(233,150,122)),u.darkseagreen=Object.freeze(u(143,188,143)),u.darkslateblue=Object.freeze(u(72,61,139)),u.darkslategray=Object.freeze(u(47,79,79)),u.darkslategrey=Object.freeze(u(47,79,79)),u.darkturquoise=Object.freeze(u(0,206,209)),u.darkviolet=Object.freeze(u(148,0,211)),u.deeppink=Object.freeze(u(255,20,147)),u.deepskyblue=Object.freeze(u(0,191,255)),u.dimgray=Object.freeze(u(105,105,105)),u.dimgrey=Object.freeze(u(105,105,105)),u.dodgerblue=Object.freeze(u(30,144,255)),u.firebrick=Object.freeze(u(178,34,34)),u.floralwhite=Object.freeze(u(255,250,240)),u.forestgreen=Object.freeze(u(34,139,34)),u.fuchsia=Object.freeze(u(255,0,255)),u.gainsboro=Object.freeze(u(220,220,220)),u.ghostwhite=Object.freeze(u(248,248,255)),u.gold=Object.freeze(u(255,215,0)),u.goldenrod=Object.freeze(u(218,165,32)),u.gray=Object.freeze(u(128,128,128)),u.green=Object.freeze(u(0,128,0)),u.greenyellow=Object.freeze(u(173,255,47)),u.grey=Object.freeze(u(128,128,128)),u.honeydew=Object.freeze(u(240,255,240)),u.hotpink=Object.freeze(u(255,105,180)),u.indianred=Object.freeze(u(205,92,92)),u.indigo=Object.freeze(u(75,0,130)),u.ivory=Object.freeze(u(255,255,240)),u.khaki=Object.freeze(u(240,230,140)),u.lavender=Object.freeze(u(230,230,250)),u.lavenderblush=Object.freeze(u(255,240,245)),u.lawngreen=Object.freeze(u(124,252,0)),u.lemonchiffon=Object.freeze(u(255,250,205)),u.lightblue=Object.freeze(u(173,216,230)),u.lightcoral=Object.freeze(u(240,128,128)),u.lightcyan=Object.freeze(u(224,255,255)),u.lightgoldenrodyellow=Object.freeze(u(250,250,210)),u.lightgray=Object.freeze(u(211,211,211)),u.lightgreen=Object.freeze(u(144,238,144)),u.lightgrey=Object.freeze(u(211,211,211)),u.lightpink=Object.freeze(u(255,182,193)),u.lightsalmon=Object.freeze(u(255,160,122)),u.lightseagreen=Object.freeze(u(32,178,170)),u.lightskyblue=Object.freeze(u(135,206,250)),u.lightslategray=Object.freeze(u(119,136,153)),u.lightslategrey=Object.freeze(u(119,136,153)),u.lightsteelblue=Object.freeze(u(176,196,222)),u.lightyellow=Object.freeze(u(255,255,224)),u.lime=Object.freeze(u(0,255,0)),u.limegreen=Object.freeze(u(50,205,50)),u.linen=Object.freeze(u(250,240,230)),u.magenta=Object.freeze(u(255,0,255)),u.maroon=Object.freeze(u(128,0,0)),u.mediumaquamarine=Object.freeze(u(102,205,170)),u.mediumblue=Object.freeze(u(0,0,205)),u.mediumorchid=Object.freeze(u(186,85,211)),u.mediumpurple=Object.freeze(u(147,112,219)),u.mediumseagreen=Object.freeze(u(60,179,113)),u.mediumslateblue=Object.freeze(u(123,104,238)),u.mediumspringgreen=Object.freeze(u(0,250,154)),u.mediumturquoise=Object.freeze(u(72,209,204)),u.mediumvioletred=Object.freeze(u(199,21,133)),u.midnightblue=Object.freeze(u(25,25,112)),u.mintcream=Object.freeze(u(245,255,250)),u.mistyrose=Object.freeze(u(255,228,225)),u.moccasin=Object.freeze(u(255,228,181)),u.navajowhite=Object.freeze(u(255,222,173)),u.navy=Object.freeze(u(0,0,128)),u.oldlace=Object.freeze(u(253,245,230)),u.olive=Object.freeze(u(128,128,0)),u.olivedrab=Object.freeze(u(107,142,35)),u.orange=Object.freeze(u(255,165,0)),u.orangered=Object.freeze(u(255,69,0)),u.orchid=Object.freeze(u(218,112,214)),u.palegoldenrod=Object.freeze(u(238,232,170)),u.palegreen=Object.freeze(u(152,251,152)),u.paleturquoise=Object.freeze(u(175,238,238)),u.palevioletred=Object.freeze(u(219,112,147)),u.papayawhip=Object.freeze(u(255,239,213)),u.peachpuff=Object.freeze(u(255,218,185)),u.peru=Object.freeze(u(205,133,63)),u.pink=Object.freeze(u(255,192,203)),u.plum=Object.freeze(u(221,160,221)),u.powderblue=Object.freeze(u(176,224,230)),u.purple=Object.freeze(u(128,0,128)),u.red=Object.freeze(u(255,0,0)),u.rosybrown=Object.freeze(u(188,143,143)),u.royalblue=Object.freeze(u(65,105,225)),u.saddlebrown=Object.freeze(u(139,69,19)),u.salmon=Object.freeze(u(250,128,114)),u.sandybrown=Object.freeze(u(244,164,96)),u.seagreen=Object.freeze(u(46,139,87)),u.seashell=Object.freeze(u(255,245,238)),u.sienna=Object.freeze(u(160,82,45)),u.silver=Object.freeze(u(192,192,192)),u.skyblue=Object.freeze(u(135,206,235)),u.slateblue=Object.freeze(u(106,90,205)),u.slategray=Object.freeze(u(112,128,144)),u.slategrey=Object.freeze(u(112,128,144)),u.snow=Object.freeze(u(255,250,250)),u.springgreen=Object.freeze(u(0,255,127)),u.steelblue=Object.freeze(u(70,130,180)),u.tan=Object.freeze(u(210,180,140)),u.teal=Object.freeze(u(0,128,128)),u.thistle=Object.freeze(u(216,191,216)),u.tomato=Object.freeze(u(255,99,71)),u.turquoise=Object.freeze(u(64,224,208)),u.violet=Object.freeze(u(238,130,238)),u.wheat=Object.freeze(u(245,222,179)),u.white=Object.freeze(u(255,255,255)),u.whitesmoke=Object.freeze(u(245,245,245)),u.yellow=Object.freeze(u(255,255,0)),u.yellowgreen=Object.freeze(u(154,205,50));const d={color:u.white,wireframeColor:u.black,texture:void 0,textureMapping:"ortho",textureFiltering:"none",uvWrapping:"repeat",vertexShading:"none",renderVertexShade:!0,ambientLightLevel:0,hasWireframe:!1,hasFill:!0,isTwoSided:!1,isInScreenSpace:!1,allowAlphaReject:!1,allowAlphaBlend:!1,bypassPixelBuffer:!1,depthOffset:0},h={arguments:{where:"in arguments to Rngon::ngon()",properties:{vertices:[["Vertex"]],material:["object"],vertexNormals:[["Vector"],"Vector"]}},interface:{where:"in the return value of Rngon::ngon()",properties:{$constructor:{value:"Ngon"},vertices:[["Vertex"]],vertexNormals:[["Vector"]],normal:["Vector"],material:{subschema:{allowAdditionalProperties:!0,properties:{color:["Color"],wireframeColor:["Color"],texture:["undefined","null","Texture"],textureMapping:["string"],textureFiltering:["string"],uvWrapping:["string"],vertexShading:["string"],renderVertexShade:["boolean"],ambientLightLevel:["number"],hasWireframe:["boolean"],hasFill:["boolean"],isTwoSided:["boolean"],isInScreenSpace:["boolean"],allowAlphaReject:["boolean"],allowAlphaBlend:["boolean"],depthOffset:["number"]}}},mipLevel:["number"]}}};function p(e=[l()],t={},r=c(0,1,0)){for(const e of Object.keys(d))t.hasOwnProperty(e)||(t[e]=d[e]);n?.({vertices:e,material:t,vertexNormals:r},h.arguments),Array.isArray(r)||(r=new Array(e.length).fill().map((e=>c(r.x,r.y,r.z))));const a=r.reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e.z+=t.z,e)),c(0,0,0));c.normalize(a);{const t=e.map((e=>e.u)).some((e=>e<0)),r=e.map((e=>e.v)).some((e=>e<0));if(t||r)for(const n of e)t&&0===n.u&&(n.u=-Number.EPSILON),r&&0===n.v&&(n.v=-Number.EPSILON)}const o={$constructor:"Ngon",vertices:e,vertexNormals:r,normal:a,material:t,mipLevel:0};return n?.(o,h.interface),o}p.perspective_divide=function(e=p()){for(const t of e.vertices)t.x/=t.w,t.y/=t.w},p.transform=function(e=p(),t=o()){for(const r of e.vertices)l.transform(r,t)};const m=["x","y","z"],g=[1,-1];function x(e,t,r){return e+r*(t-e)}p.clip_to_viewport=function(e){for(const t of m)for(const r of g){if(!e.vertices.length)break;if(1==e.vertices.length){if(e.vertices[0].x<=e.vertices[0].w&&-e.vertices[0].x<=e.vertices[0].w&&e.vertices[0].y<=e.vertices[0].w&&-e.vertices[0].y<=e.vertices[0].w&&e.vertices[0].z<=e.vertices[0].w&&-e.vertices[0].z<=e.vertices[0].w)break;e.vertices.length=0;break}let n=e.vertices[e.vertices.length-(2==e.vertices.length?2:1)],a=n[t]*r,o=a<=n.w,i=0;const s=e.vertices.length;for(let c=0;c<s;c++){const f=e.vertices[c],u=f[t]*r,d=u<=f.w;if(d^o){const t=(n.w-a)/(n.w-a-(f.w-u));e.vertices[s+i++]=l(x(n.x,f.x,t),x(n.y,f.y,t),x(n.z,f.z,t),x(n.u,f.u,t),x(n.v,f.v,t),x(n.normalX,f.normalX,t),x(n.normalY,f.normalY,t),x(n.normalZ,f.normalZ,t),x(n.w,f.w,t),x(n.shade,f.shade,t),x(n.worldX,f.worldX,t),x(n.worldY,f.worldY,t),x(n.worldZ,f.worldZ,t))}d&&(e.vertices[s+i++]=f),n=f,a=u,o=d}e.vertices.splice(0,s)}};const b={enabled:[[[.25,0],[.5,.75]],[[.75,.5],[0,.25]]],disabled:[[[0,0],[0,0]],[[0,0],[0,0]]]};function v({renderContext:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:a,numRightEdges:o}){if(!a||!o)return!0;const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.useDepthBuffer?e.depthBuffer.data:null,u=e.pixelBuffer.width,d=t.material,h=d.texture||null,p=h&&"dither"===d.textureFiltering?b.enabled:b.disabled;let m=null,g=0;if(h){const e=h.mipLevels.length;g=Math.max(0,Math.min(e-1,Math.round((e-1)*t.mipLevel))),m=h.mipLevels[g]}let x=0,v=0,w=r[x],y=n[v];const z=r[0].top,j=r[a-1].bottom;let O=z-1;for(;++O<j;){const a=Math.min(u,Math.max(0,Math.round(w.x))),o=Math.min(u,Math.max(0,Math.ceil(y.x))),g=o-a+1;if(g>0){const r=i?1:w.invW,n=i?1:y.invW,x=i?(y.invW-w.invW)/g:0,b=i?w.invW:1,v=(y.depth/n-w.depth/r)/g,B=w.depth/r,M=(y.shade/n-w.shade/r)/g,S=w.shade/r,P=(y.u/n-w.u/r)/g,k=w.u/r,C=(y.v/n-w.v/r)/g,W=w.v/r,A=(y.worldX/n-w.worldX/r)/g,_=w.worldX/r,L=(y.worldY/n-w.worldY/r)/g,N=w.worldY/r,R=(y.worldZ/n-w.worldZ/r)/g,X=w.worldZ/r,Y=(y.normalX/n-w.normalX/r)/g,Z=w.normalX/r,$=(y.normalY/n-w.normalY/r)/g,V=w.normalY/r,D=(y.normalZ/n-w.normalZ/r)/g,F=w.normalZ/r;let T=a+O*u-1,I=a-1,U=0;for(;++I<o;){let r=0,n=0;const o=B+v*U,i=S+M*U,u=k+P*U,w=W+C*U,y=b+x*U,q=_+A*U,H=N+L*U,G=X+R*U,J=Z+Y*U,K=V+$*U,Q=F+D*U;T++,U++;const ee=o/y;if(f&&f[T]<=ee)continue;let te=d.renderVertexShade?i/y:1,re=0,ne=0,ae=0;if(h){switch(d.textureMapping){case"affine":switch(r=u/y,n=w/y,d.uvWrapping){case"clamp":{const e=1-Number.EPSILON;r=r<0?e+r:r,n=n<0?e+n:n;const t=p[1&O][1&I];r+=t[0]/m.width,n+=t[1]/m.height,r=m.width*(r<0?0:r>e?e:r),n=m.height*(n<0?0:n>e?e:n);break}case"repeat":{const e=p[1&O][1&I];r+=e[0]/m.width,n+=e[1]/m.height,r=m.width*(r-Math.floor(r)),n=m.height*(n-Math.floor(n));const t=Math.abs(r),a=Math.abs(n),o=t-~~t,i=a-~~a;r=(r&m.width-1)+o,n=(n&m.height-1)+i;break}default:throw new Error("Unrecognized UV wrapping mode.")}break;case"affine-npot":{r=u/y,n=w/y;const e=1-Number.EPSILON;r=r<0?e+r:r,n=n<0?e+n:n;const t=p[1&O][1&I];r+=t[0]/m.width,n+=t[1]/m.height,r=m.width*(r<0?0:r>e?e:r),n=m.height*(n<0?0:n>e?e:n)}break;case"ortho":{const e=j-z,t=I-a+1,o=O-z+1,i=p[1&O][1&I];r+=i[0],n+=i[1],r=t*(m.width/g),n=o*(m.height/e),n=m.height-n;break}default:throw new Error("Unknown texture-mapping mode.")}const e=4*(~~r+~~n*m.width);if(d.allowAlphaReject&&255!==m.pixels[e+3])continue;if(d.allowAlphaBlend&&E.stipple_test(d.color.alpha,I,O))continue;re=m.pixels[e+0],ne=m.pixels[e+1],ae=m.pixels[e+2]}else{if(d.allowAlphaBlend&&E.stipple_test(d.color.alpha,I,O))continue;re=d.color.red*te,ne=d.color.green*te,ae=d.color.blue*te}if(re*=te*d.color.unitRange.red,ne*=te*d.color.unitRange.green,ae*=te*d.color.unitRange.blue,!d.bypassPixelBuffer)if(te>1){const t=4*T;e.pixelBuffer8[t+0]=re,e.pixelBuffer8[t+1]=ne,e.pixelBuffer8[t+2]=ae,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[T]=(255<<24)+(ae<<16)+(ne<<8)+~~re;if(f&&(f[T]=ee),l){const e=c[T];!s.ngon||(e.ngon=t),!s.textureUScaled||(e.textureUScaled=~~r),!s.textureVScaled||(e.textureVScaled=~~n),!s.shade||(e.shade=i/y),!s.worldX||(e.worldX=q/y),!s.worldY||(e.worldY=H/y),!s.worldZ||(e.worldZ=G/y),!s.normalX||(e.normalX=J/y),!s.normalY||(e.normalY=K/y),!s.normalZ||(e.normalZ=Q/y)}}}w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.u+=w.delta.u,w.v+=w.delta.v,w.invW+=w.delta.invW,w.worldX+=w.delta.worldX,w.worldY+=w.delta.worldY,w.worldZ+=w.delta.worldZ,w.normalX+=w.delta.normalX,w.normalY+=w.delta.normalY,w.normalZ+=w.delta.normalZ,y.x+=y.delta.x,y.depth+=y.delta.depth,y.shade+=y.delta.shade,y.u+=y.delta.u,y.v+=y.delta.v,y.invW+=y.delta.invW,y.worldX+=y.delta.worldX,y.worldY+=y.delta.worldY,y.worldZ+=y.delta.worldZ,y.normalX+=y.delta.normalX,y.normalY+=y.delta.normalY,y.normalZ+=y.delta.normalZ,O===w.bottom-1&&(w=r[++x]),O===y.bottom-1&&(y=n[++v])}return!0}function w({renderContext:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:a,numRightEdges:o}){const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.pixelBuffer.width,u=e.useDepthBuffer?e.depthBuffer.data:null,d=t.material;let h=0,p=0,m=r[h],g=n[p];if(!a||!o)return;const x=r[0].top,b=r[a-1].bottom;let v=x-1;for(;++v<b;){const a=Math.min(f,Math.max(0,Math.round(m.x))),o=Math.min(f,Math.max(0,Math.ceil(g.x))),x=o-a+1;if(x>0){const r=i?1:m.invW,n=i?1:g.invW,h=i?(g.invW-m.invW)/x:0,p=i?m.invW:1,b=(g.depth/n-m.depth/r)/x,w=m.depth/r,y=(g.shade/n-m.shade/r)/x,z=m.shade/r;let j=a+v*f-1,O=a-1,B=0;for(;++O<o;){const r=w+b*B,n=z+y*B,a=p+h*B;j++,B++;const o=r/a;if(!(u[j]<=o)){const r=d.renderVertexShade?n/a:1,i=d.color.red*r,f=d.color.green*r,h=d.color.blue*r;if(r>1){const t=4*j;e.pixelBuffer8[t+0]=i,e.pixelBuffer8[t+1]=f,e.pixelBuffer8[t+2]=h,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[j]=(255<<24)+(h<<16)+(f<<8)+~~i;if(u[j]=o,l){const e=c[j];!s.ngon||(e.ngon=t),!s.shade||(e.shade=n/a)}}}}m.x+=m.delta.x,m.depth+=m.delta.depth,m.shade+=m.delta.shade,m.invW+=m.delta.invW,g.x+=g.delta.x,g.depth+=g.delta.depth,g.shade+=g.delta.shade,g.invW+=g.delta.invW,v===m.bottom-1&&(m=r[++h]),v===g.bottom-1&&(g=n[++p])}return!0}function y({renderContext:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:a,numRightEdges:o}){if(!a||!o)return!0;const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.pixelBuffer.width,u=e.useDepthBuffer?e.depthBuffer.data:null,d=t.material,h=d.texture||null;let p=null,m=0;const g=h.mipLevels.length;m=Math.max(0,Math.min(g-1,Math.round((g-1)*t.mipLevel))),p=h.mipLevels[m];let x=0,b=0,v=r[x],w=n[b];const y=r[0].top,z=r[a-1].bottom;let j=y-1;for(;++j<z;){const a=Math.min(f,Math.max(0,Math.round(v.x))),o=Math.min(f,Math.max(0,Math.ceil(w.x))),h=o-a+1;if(h>0){const r=i?1:v.invW,n=i?1:w.invW,m=i?(w.invW-v.invW)/h:0,g=i?v.invW:1,x=(w.depth/n-v.depth/r)/h,b=v.depth/r,y=(w.shade/n-v.shade/r)/h,z=v.shade/r,O=(w.u/n-v.u/r)/h,B=v.u/r,M=(w.v/n-v.v/r)/h,S=v.v/r;let P=a+j*f-1,k=a-1,C=0;for(;++k<o;){const r=b+x*C,n=z+y*C,a=g+m*C,o=B+O*C,i=S+M*C;P++,C++;const f=r/a;if(u[P]<=f)continue;let h=o/a,v=i/a;switch(d.uvWrapping){case"clamp":{const e=1-Number.EPSILON;h=h<0?e+h:h,v=v<0?e+v:v,h=p.width*(h<0?0:h>e?e:h),v=p.height*(v<0?0:v>e?e:v);break}case"repeat":h=p.width*(h-Math.floor(h)),v=p.height*(v-Math.floor(v)),h&=p.width-1,v&=p.height-1;break;default:throw new Error("Unrecognized UV wrapping mode.")}const w=4*(~~h+~~v*p.width);{const r=d.renderVertexShade?n/a:1,o=p.pixels[w+0]*r,i=p.pixels[w+1]*r,m=p.pixels[w+2]*r;if(r>1){const t=4*P;e.pixelBuffer8[t+0]=o,e.pixelBuffer8[t+1]=i,e.pixelBuffer8[t+2]=m,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[P]=(255<<24)+(m<<16)+(i<<8)+~~o;if(u[P]=f,l){const e=c[P];!s.ngon||(e.ngon=t),!s.textureUScaled||(e.textureUScaled=~~h),!s.textureVScaled||(e.textureVScaled=~~v),!s.shade||(e.shade=n/a)}}}}v.x+=v.delta.x,v.depth+=v.delta.depth,v.shade+=v.delta.shade,v.u+=v.delta.u,v.v+=v.delta.v,v.invW+=v.delta.invW,w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.u+=w.delta.u,w.v+=w.delta.v,w.invW+=w.delta.invW,j===v.bottom-1&&(v=r[++x]),j===w.bottom-1&&(w=n[++b])}return!0}function z({renderContext:e,ngon:t,leftEdges:r,rightEdges:n,numLeftEdges:a,numRightEdges:o}){if(!a||!o)return!0;const i=e.useFullInterpolation,l=e.useFragmentBuffer,s=e.fragments,c=e.fragmentBuffer.data,f=e.pixelBuffer.width,u=e.useDepthBuffer?e.depthBuffer.data:null,d=t.material,h=d.texture||null;let p=null,m=0;const g=h.mipLevels.length;m=Math.max(0,Math.min(g-1,Math.round((g-1)*t.mipLevel))),p=h.mipLevels[m];let x=0,b=0,v=r[x],w=n[b];const y=r[0].top,z=r[a-1].bottom;let j=y-1;for(;++j<z;){const a=Math.min(f,Math.max(0,Math.round(v.x))),o=Math.min(f,Math.max(0,Math.ceil(w.x))),h=o-a+1;if(h>0){const r=i?1:v.invW,n=i?1:w.invW,m=i?(w.invW-v.invW)/h:0,g=i?v.invW:1,x=(w.depth/n-v.depth/r)/h,b=v.depth/r,y=(w.shade/n-v.shade/r)/h,z=v.shade/r,O=(w.u/n-v.u/r)/h,B=v.u/r,M=(w.v/n-v.v/r)/h,S=v.v/r;let P=a+j*f-1,k=a-1,C=0;for(;++k<o;){const r=b+x*C,n=z+y*C,a=g+m*C,o=B+O*C,i=S+M*C;P++,C++;const f=r/a;if(u[P]<=f)continue;let h=o/a,v=i/a;switch(d.uvWrapping){case"clamp":{const e=1-Number.EPSILON;h=h<0?e+h:h,v=v<0?e+v:v,h=p.width*(h<0?0:h>e?e:h),v=p.height*(v<0?0:v>e?e:v);break}case"repeat":{h=p.width*(h-Math.floor(h)),v=p.height*(v-Math.floor(v));const e=Math.abs(h),t=Math.abs(v),r=e-~~e,n=t-~~t;h=(h&p.width-1)+r,v=(v&p.height-1)+n;break}default:throw new Error("Unrecognized UV wrapping mode.")}const w=4*(~~h+~~v*p.width);{const r=d.renderVertexShade?n/a:1,o=p.pixels[w+0]*r*d.color.unitRange.red,i=p.pixels[w+1]*r*d.color.unitRange.green,m=p.pixels[w+2]*r*d.color.unitRange.blue;if(r>1){const t=4*P;e.pixelBuffer8[t+0]=o,e.pixelBuffer8[t+1]=i,e.pixelBuffer8[t+2]=m,e.pixelBuffer8[t+3]=255}else e.pixelBuffer32[P]=(255<<24)+(m<<16)+(i<<8)+~~o;if(u[P]=f,l){const e=c[P];!s.ngon||(e.ngon=t),!s.textureUScaled||(e.textureUScaled=~~h),!s.textureVScaled||(e.textureVScaled=~~v),!s.shade||(e.shade=n/a)}}}}v.x+=v.delta.x,v.depth+=v.delta.depth,v.shade+=v.delta.shade,v.u+=v.delta.u,v.v+=v.delta.v,v.invW+=v.delta.invW,w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.u+=w.delta.u,w.v+=w.delta.v,w.invW+=w.delta.invW,j===v.bottom-1&&(v=r[++x]),j===w.bottom-1&&(w=n[++b])}return!0}function j(e,t=l(),r=l(),n={}){const a=n.wireframeColor;if(n.allowAlphaReject&&a.alpha<255)return!0;const o=e.useDepthBuffer?e.depthBuffer.data:null,i=e.pixelBuffer.width,s=e.pixelBuffer.height,c=e.useFragmentBuffer,f=e.fragmentBuffer.data,u=e.fragments;let d;c&&u.ngon&&(d=Rngon.ngon([t,r],n));const h=Math.floor(t.x),p=Math.floor(t.y),m=Math.floor(r.x),g=Math.ceil(r.y);let x=Math.ceil(Math.sqrt((m-h)**2+(g-p)**2));const b=(m-h)/x,v=(g-p)/x,w=t.z/e.farPlaneDistance,y=(r.z/e.farPlaneDistance-w)/x,z=n.renderVertexShade?t.shade:1,j=((n.renderVertexShade?r.shade:1)-z)/x;let O=0;for(;x--;){const t=h+b*O,r=p+v*O,l=w+y*O,m=z+j*O;O++;const g=~~t,x=~~r,B=g+x*i;if(g>=0&&x>=0&&g<i&&x<s&&(!o||o[B]>=l)){const t=a.red*m,r=a.green*m,i=a.blue*m;if(!n.bypassPixelBuffer)if(m>1){const n=4*B;e.pixelBuffer8[n+0]=t,e.pixelBuffer8[n+1]=r,e.pixelBuffer8[n+2]=i,e.pixelBuffer8[n+3]=255}else e.pixelBuffer32[B]=(255<<24)+(i<<16)+(r<<8)+~~t;o&&(o[B]=l),c&&u.ngon&&(f[B].ngon=d)}}return!0}function O(e,t=l(),r=l(),n={}){const a=e.pixelBuffer.width,o=e.pixelBuffer.height,i=Math.floor(t.x),s=Math.floor(t.y),c=Math.floor(r.x),f=Math.ceil(r.y);let u=Math.ceil(Math.sqrt((c-i)**2+(f-s)**2));const d=(c-i)/u,h=(f-s)/u,p=(255<<24)+(n.color.blue<<16)+(n.color.green<<8)+~~n.color.red;let m=0;for(;u--;){const t=i+d*m,r=s+h*m;m++;const n=~~t,l=~~r;if(n>=0&&l>=0&&n<a&&l<o){const t=n+l*a;e.pixelBuffer32[t]=p}}return!0}function B(e,t=l(),r={}){const n=e.useDepthBuffer?e.depthBuffer.data:null,a=e.pixelBuffer.width,o=Math.floor(t.x)+Math.floor(t.y)*a,i=t.z/e.farPlaneDistance,s=r.color;if(!(n&&n[o]<=i)){{const a=t.shade;if(!r.bypassPixelBuffer){const t=s.red*a,r=s.green*a,n=s.blue*a;if(a>1){const a=4*o;e.pixelBuffer8[a+0]=t,e.pixelBuffer8[a+1]=r,e.pixelBuffer8[a+2]=n,e.pixelBuffer8[a+3]=255}else e.pixelBuffer32[o]=(255<<24)+(n<<16)+(r<<8)+~~t}n&&(n[o]=i)}return!0}}function M(e,t=l(),r=u()){return e.pixelBuffer32[Math.floor(t.x)+Math.floor(t.y)*e.pixelBuffer.width]=(255<<24)+(r.blue<<16)+(r.green<<8)+~~r.red,!0}const S=500,P=new Array(S),k=new Array(S),C=new Array(S).fill().map((()=>({top:void 0,bottom:void 0,start:{},delta:{}}))),W=new Array(S).fill().map((()=>({top:void 0,bottom:void 0,start:{},delta:{}}))),A=(e,t)=>e.y===t.y?0:e.y<t.y?-1:1;function E(e){for(const t of e.screenSpaceNgons)switch(r?.(t.vertices.length,"Encountered an n-gon with 0 vertices"),t.vertices.length){case 0:continue;case 1:E.point(e,t.vertices[0],t.material);break;case 2:E.line(e,t.vertices[0],t.vertices[1],t.material);break;default:E.polygon(e,t)}}E.polygon=function(e,t=p()){r?.(t.vertices.length>=3,"Polygons must have 3 or more vertices"),r?.(t.vertices.length<S,"Overflowing the vertex buffer");const n=e.useFragmentBuffer,a=e.fragments,o=e.useDepthBuffer?e.depthBuffer.data:null,i=e.pixelBuffer.width,l=e.pixelBuffer.height,s=t.material;let c=0,f=0,u=0,d=0;!function(){t.vertices.sort(A);const e=t.vertices[0],r=t.vertices[t.vertices.length-1];P[c++]=e,k[f++]=e;for(let o=1;o<t.vertices.length-1;o++){const i=(n=e.x,a=r.x,n+(t.vertices[o].y-e.y)/(r.y-e.y)*(a-n));t.vertices[o].x>=i?k[f++]=t.vertices[o]:P[c++]=t.vertices[o]}var n,a;P[c++]=r,k[f++]=r}(),function(){for(let e=1;e<c;e++)r(P[e-1],P[e],!0);for(let e=1;e<f;e++)r(k[e-1],k[e],!1);function r(r,a,o){const c=Math.min(l,Math.max(0,Math.floor(r.y))),f=Math.min(l,Math.max(0,Math.floor(a.y))),h=f-c;if(0===h)return;const p=Math.min(i,Math.max(0,Math.floor(r.x))),m=(Math.min(i,Math.max(0,Math.floor(a.x)))-p)/h,g=s.texture?r.u:1,x=s.texture?1-r.v:1,b=s.texture?a.u:1,v=s.texture?1-a.v:1,w=r.w,y=a.w,z=r.z+t.material.depthOffset,j=a.z+t.material.depthOffset,O=o?C[u++]:W[d++];O.top=c,O.bottom=f,O.x=p,O.delta.x=m,O.depth=z/e.farPlaneDistance/w,O.delta.depth=(j/e.farPlaneDistance/y-O.depth)/h,O.shade=r.shade/w,O.delta.shade=(a.shade/y-O.shade)/h,O.u=g/w,O.delta.u=(b/y-O.u)/h,O.v=x/w,O.delta.v=(v/y-O.v)/h,O.invW=1/w,O.delta.invW=(1/y-O.invW)/h,n&&(O.worldX=r.worldX/w,O.delta.worldX=(a.worldX/y-O.worldX)/h,O.worldY=r.worldY/w,O.delta.worldY=(a.worldY/y-O.worldY)/h,O.worldZ=r.worldZ/w,O.delta.worldZ=(a.worldZ/y-O.worldZ)/h,O.normalX=r.normalX/w,O.delta.normalX=(a.normalX/y-O.normalX)/h,O.normalY=r.normalY/w,O.delta.normalY=(a.normalY/y-O.normalY)/h,O.normalZ=r.normalZ/w,O.delta.normalZ=(a.normalZ/y-O.normalZ)/h)}}();const h={renderContext:e,ngon:t,leftEdges:C,rightEdges:W,numLeftEdges:u,numRightEdges:d};if(s.hasFill&&!e.pipeline.raster_path?.(h)){let e=v;s.bypassPixelBuffer||!s.texture||!o||a.worldX||a.worldY||a.worldZ||a.normalX||a.normalY||a.normalZ||s.allowAlphaReject||s.allowAlphaBlend||"affine"!==s.textureMapping||"dither"===s.textureFiltering?s.bypassPixelBuffer||s.texture||!o||a.worldX||a.worldY||a.worldZ||a.normalX||a.normalY||a.normalZ||s.allowAlphaReject||s.allowAlphaBlend||(e=w):e=255===s.color.red&&255===s.color.green&&255===s.color.blue&&"none"===s.textureFiltering?y:z,e(h)}if(s.hasWireframe){for(let t=1;t<c;t++)E.line(e,P[t-1],P[t],s);for(let t=1;t<f;t++)E.line(e,k[t-1],k[t],s)}},E.line=function(e,t=l(),r=l(),n={}){const a=e.pixelBuffer.width,o=e.pixelBuffer.height;if(!(t.x<0&&r.x<0||t.x>=a&&r.x>=a||t.y<0&&r.y<0||t.y>=o&&r.y<o)){let a=j;n.bypassPixelBuffer||255!==n.color.alpha||e.useFragmentBuffer||e.useDepthBuffer||n.renderVertexShade&&(1!==t.shade||1!==r.shade)||(a=O),a(e,t,r,n)}},E.point=function(e,t=l(),r={}){if(r.allowAlphaReject&&255!=r.color.alpha)return;const n=e.pixelBuffer.width,a=e.pixelBuffer.height;if(!(t.x<0||t.y<0||t.x>=n||t.y>=a)){let n=B;r.bypassPixelBuffer||e.useDepthBuffer||1!==t.shade||(n=M),n(e,t,r)}},E.stipple_test=function(){const e=[{width:8,height:6,pixels:[0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},{width:4,height:4,pixels:[0,1,0,1,1,1,1,1,1,0,1,0,1,1,1,1]},{width:2,height:2,pixels:[1,0,0,1]}];for(let t=e.length-2;t>=0;t--)e.push({width:e[t].width,height:e[t].height,pixels:e[t].pixels.map((e=>Number(!e)))});return function(t,r,n){if(t<=0)return!0;if(t>=255)return!1;{const a=Math.floor(t/(256/e.length)),o=e[a],i=r%o.width+n%o.height*o.width;if(o.pixels[i])return!0}return!1}}();const _={translate:c(0,0,0),rotate:c(0,0,0),scale:c(1,1,1)},L={where:"in arguments to Rngon::mesh()",properties:{ngons:[["Ngon"]],transform:{subschema:{properties:{translate:{optional:!0,type:["Vector"]},rotate:{optional:!0,type:["Vector"]},scale:{optional:!0,type:["Vector"]}}}}}},N={where:"in the return value of Rngon::mesh()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Mesh"},ngons:[["Ngon"]],rotate:["Vector"],translate:["Vector"],scale:["Vector"]}};function R(e,t){r?.(["flat","gouraud"].includes(e.material.vertexShading),`Unrecognized shading mode: ${e.material.vertexShading}`);const n=c();let a=e.material.ambientLightLevel;for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=e.material.ambientLightLevel;let o=0,i=0,l=0;if("flat"===e.material.vertexShading){for(const t of e.vertices)o+=t.x,i+=t.y,l+=t.z;o/=e.vertices.length,i/=e.vertices.length,l/=e.vertices.length}for(const r of t.lights)if("gouraud"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++){const a=e.vertices[t],o=1/(1+Math.sqrt((a.x-r.x)**2+(a.y-r.y)**2+(a.z-r.z)**2));n.x=r.x-a.x,n.y=r.y-a.y,n.z=r.z-a.z,c.normalize(n);const i=e.vertices.length<3?1:c.dot(e.vertexNormals[t],n),l=Math.max(0,Math.min(1,i));a.shade=Math.max(a.shade,Math.min(1,l*o*r.intensity))}else if("flat"===e.material.vertexShading){const t=1/(1+Math.sqrt((o-r.x)**2+(i-r.y)**2+(l-r.z)**2));n.x=r.x-o,n.y=r.y-i,n.z=r.z-l,c.normalize(n);const s=e.vertices.length<3?1:c.dot(e.normal,n),f=Math.max(0,Math.min(1,s));a=Math.max(a,Math.min(1,f*t*r.intensity))}if("flat"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=a}const X={where:"in arguments to Rngon::surface()",properties:{canvasElement:["HTMLCanvasElement","undefined"],renderContext:["Context"]}},Y={where:"in the return value of Rngon::surface()",properties:{$constructor:{value:"Surface"},width:["number"],height:["number"],display_meshes:["function"],is_in_view:["function"]}};const Z="default";function $(e=void 0){return void 0===e&&(e=Z),$.list[e]||($.list[e]=$.instance())}$.instance=function(){return{$constructor:"Context",contextName:void 0,pipeline:{ngon_sorter:void 0,transform_clip_lighter:void 0,surface_wiper:void 0,rasterizer:void 0,vertex_shader:void 0,pixel_shader:void 0,canvas_shader:void 0,raster_path:void 0},resolution:{width:void 0,height:void 0},pixelBuffer:void 0,pixelBuffer8:void 0,pixelBuffer32:void 0,useDepthBuffer:!1,depthBuffer:{width:0,height:0,data:void 0,resize(e,t){this.width=e,this.height=t,this.data=new Float64Array(e*t)},clear(){this.data.fill(1)}},useFragmentBuffer:!1,fragmentBuffer:{width:0,height:0,data:void 0,resize(e,t){this.width=e,this.height=t,this.data=new Array(e*t).fill().map((e=>({})))}},fragments:{ngon:!0,textureUScaled:!0,textureVScaled:!0,shade:!0,worldX:!0,worldY:!0,worldZ:!0,normalX:!0,normalY:!0,normalZ:!0},usePixelShader:!1,pixel_shader:void 0,useVertexShader:!1,vertex_shader:void 0,useCanvasShader:!1,canvas_shader:void 0,renderScale:void 0,useFullInterpolation:!0,nearPlaneDistance:1,farPlaneDistance:1,fov:45,cameraDirection:void 0,cameraPosition:void 0,allowWindowAlert:!1,screenSpaceNgons:[],ngonCache:{count:0,ngons:[]},vertexCache:{count:0,vertices:[]},vertexNormalCache:{count:0,normals:[]},lights:[]}},$.list={[Z]:$.instance()};const V={cameraPosition:c(0,0,0),cameraDirection:c(0,0,0),context:void 0,resolution:1,fov:43,nearPlane:1,farPlane:1e3,useDepthBuffer:!0,useFragmentBuffer:!1,useBackfaceCulling:!1,useFullInterpolation:!0,fragments:void 0,hibernateWhenTargetNotVisible:!0,lights:[]},D={ngonSorter:function(e){e.useDepthBuffer&&e.screenSpaceNgons.sort(((e,t)=>{const r=e.vertices.reduce(((e,t)=>e+t.z),0)/e.vertices.length,n=t.vertices.reduce(((e,t)=>e+t.z),0)/t.vertices.length;return r===n?0:r>n?1:-1}))},surfaceWiper:function(e){e.pixelBuffer.data.fill(0),e.useDepthBuffer&&e.depthBuffer.clear()},rasterizer:E,transformClipLighter:function({renderContext:e,mesh:t,cameraMatrix:r,perspectiveMatrix:n,screenSpaceMatrix:a}={}){const i={x:0,y:0,z:0},l=e.ngonCache,s=e.vertexCache,f=e.vertexNormalCache,u=o.multiply(n,r),d=function(e){const t=o.translating(e.translate.x,e.translate.y,e.translate.z),r=o.rotating(e.rotate.x,e.rotate.y,e.rotate.z),n=o.scaling(e.scale.x,e.scale.y,e.scale.z);return o.multiply(o.multiply(t,r),n)}(t);for(const r of t.ngons){if(!r.material.hasWireframe&&r.material.allowAlphaReject&&r.material.color.alpha<=0)continue;const t=l.ngons[l.count++];t.vertices.length=0;for(let e=0;e<r.vertices.length;e++){const n=r.vertices[e],a=t.vertices[e]=s.vertices[s.count++];a.x=n.x,a.y=n.y,a.z=n.z,a.u=n.u,a.v=n.v,a.w=n.w,a.shade=n.shade,t.vertexNormals[e]=f.normals[f.count++],t.vertexNormals[e].x=r.vertexNormals[e].x,t.vertexNormals[e].y=r.vertexNormals[e].y,t.vertexNormals[e].z=r.vertexNormals[e].z}if(t.material=r.material,t.normal.x=r.normal.x,t.normal.y=r.normal.y,t.normal.z=r.normal.z,t.mipLevel=r.mipLevel,p.transform(t,d),e.useFragmentBuffer)for(let e=0;e<t.vertices.length;e++)t.vertices[e].worldX=t.vertices[e].x,t.vertices[e].worldY=t.vertices[e].y,t.vertices[e].worldZ=t.vertices[e].z;for(let e=0;e<t.vertices.length;e++)c.transform(t.vertexNormals[e],d),c.normalize(t.vertexNormals[e]),t.vertices[e].normalX=t.vertexNormals[e].x,t.vertices[e].normalY=t.vertexNormals[e].y,t.vertices[e].normalZ=t.vertexNormals[e].z;if(c.transform(t.normal,d),c.normalize(t.normal),e.useBackfaceCulling&&t.vertices.length>2&&!t.material.isTwoSided&&(i.x=t.vertices[0].x-e.cameraPosition.x,i.y=t.vertices[0].y-e.cameraPosition.y,i.z=t.vertices[0].z-e.cameraPosition.z,c.dot(t.normal,i)>=0))l.count--;else if("none"!==t.material.vertexShading&&R(t,e),e.useVertexShader&&e.pipeline.vertex_shader(t,e),!t.material.isInScreenSpace){if(p.transform(t,u),p.clip_to_viewport(t),!t.vertices.length){l.count--;continue}p.transform(t,a),p.perspective_divide(t)}}e.screenSpaceNgons=l.ngons.slice(0,l.count)},pixelShader:void 0,vertexShader:void 0,canvasShader:void 0,rasterPath:void 0},F={where:"in arguments to Rngon::render()",properties:{target:["HTMLCanvasElement","string","undefined"],meshes:[["Mesh"],"undefined"],options:["object"],pipeline:["object"]}},T={where:"in render({options})",properties:{cameraPosition:["Vector"],cameraDirection:["Vector"],context:["string","number","undefined"],resolution:["number","object"],fov:["number"],nearPlane:["number"],farPlane:["number"],useDepthBuffer:["boolean"],useFragmentBuffer:["boolean"],useBackfaceCulling:["boolean"],useFullInterpolation:["boolean"],fragments:["object","undefined"],hibernateWhenTargetNotVisible:["boolean"],lights:[["Light","object"]]}},I={where:"in render({pipeline})",properties:{ngonSorter:["undefined","function"],surfaceWiper:["undefined","null","function"],rasterizer:["undefined","null","function"],transformClipLighter:["undefined","null","function"],pixelShader:["undefined","function"],vertexShader:["undefined","function"],canvasShader:["undefined","function"],rasterPath:["undefined","function"]}},U={where:"in arguments to Rngon::light()",properties:{x:["number"],y:["number"],z:["number"],options:{subschema:{allowAdditionalProperties:!0,properties:{intensity:["number"]}}}}},q={where:"in the return value of Rngon::light()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Light"},x:["number"],y:["number"],z:["number"]}},H=4,G={width:1,height:1,pixels:void 0,encoding:"none",channels:"rgba:8+8+8+8"},J={arguments:{where:"in arguments to Rngon::texture()",allowAdditionalProperties:!0,properties:{pixels:["Uint8ClampedArray",["number"],"string"],width:{type:["number"],value(e){if(e<1||e>32768)return"Texture width must be in the range [1, 32768]"}},height:{type:["number"],value(e){if(e<1||e>32768)return"Texture height must be in the range [1, 32768]"}},encoding:{type:["string"],value(e){const t=["none","base64"];if(!t.includes(e))return`Texture encoding must be one of ${t.join(", ")}`}},channels:{type:["string"],value(e){const t=["binary","rgba:5+5+5+1","rgba:8+8+8+8"];if(!t.includes(e))return`Texture pixel layout must be one of ${t.join(", ")}`}}}},interface:{where:"in the return value of Rngon::texture()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Texture"},width:["number"],height:["number"],pixels:["Uint8ClampedArray"],mipLevels:[["object","Texture"]]}}};function K(e={}){e=structuredClone(e);for(const t of Object.keys(G))e.hasOwnProperty(t)||(e[t]=G[t]);void 0===e.pixels&&(e.pixels=new Array(e.width*e.height*4)),n?.(e,J.arguments),function(e){if("none"===e.encoding)r?.("rgba:8+8+8+8"===e.channels&&e.pixels.length===e.width*e.height*4,"Unencoded pixel data must be provided in 'rgba:8+8+8+8' format."),e.pixels instanceof Uint8ClampedArray||(e.pixels=new Uint8ClampedArray(e.pixels));else if("base64"===e.encoding){const t=atob(e.pixels);switch(e.pixels=new Uint8ClampedArray(e.width*e.height*H),e.channels){case"rgba:8+8+8+8":r?.(t.length===e.width*e.height*H,"Unexpected data length for a Base64-encoded texture; expected 4 bytes per pixel.");for(let r=0;r<e.width*e.height*4;r++)e.pixels[r]=t.charCodeAt(r);break;case"rgba:5+5+5+1":{r?.(t.length===e.width*e.height*2,"Unexpected data length for a Base64-encoded texture; expected 2 bytes per pixel.");let n=0;for(let r=0;r<e.width*e.height*2;r+=2){const a=t.charCodeAt(r)+(t.charCodeAt(r+1)<<8);e.pixels[n++]=8*(31&a),e.pixels[n++]=8*(a>>5&31),e.pixels[n++]=8*(a>>10&31),e.pixels[n++]=255*(a>>15&1)}break}case"binary":r?.(t.length===e.width*e.height,"Unexpected data length for a Base64-encoded texture; expected 1 byte per pixel.");for(let r=0;r<e.width*e.height;r++){const n=4*r,a=255*t.charCodeAt(r);e.pixels[n+0]=a,e.pixels[n+1]=a,e.pixels[n+2]=a,e.pixels[n+3]=a}break;default:throw new Error("Unrecognized value for texture 'channels' attribute.")}}else if("none"!==e.encoding)throw new Error("Unknown texture data encoding '"+e.encoding+"'.");r?.(e.pixels instanceof Uint8ClampedArray,"Expected texture data to be output as a Uint8ClampedArray."),r?.(e.pixels.length===e.width*e.height*H,"The texture's pixel array size doesn't match its width and height.")}(e);const t={$constructor:"Texture",regenerate_mipmaps:Q,...e};return t.regenerate_mipmaps(),n?.(t,J.interface),t}function Q(){if(r?.(this.hasOwnProperty("$constructor")&&"Texture"===this.$constructor,"Expected 'this' to point to a Texture"),this.mipLevels=[this],1!==this.width||1!==this.height)for(let e=1;;e++){const t=Math.max(1,Math.floor(this.width/Math.pow(2,e))),n=Math.max(1,Math.floor(this.height/Math.pow(2,e))),a=[];{const e=this.width/t,r=this.height/n;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const i=(n+o*t)*H,l=(Math.floor(n*e)+Math.floor(o*r)*this.width)*H;for(let e=0;e<H;e++)a[i+e]=this.pixels[l+e]}}if(this.mipLevels.push({width:t,height:n,pixels:a}),1===t&&1===n){r?.(this.mipLevels.length>0,"Failed to generate mip levels for a texture.");break}}}K.load=async function(e){try{const t=await fetch(e);return K(await t.json())}catch(t){throw new Error(`Failed to create a texture with data from file '${e}'. ${t}`)}};const ee={render:{options:V,pipeline:D},mesh:{transform:_},texture:G,ngon:{material:d},context:Z},te={version:Object.freeze({major:1,minor:0,isProductionBuild:!0}),default:ee,render:function({target:e,meshes:t,options:a={},pipeline:i={}}={}){n?.({target:e,meshes:t,options:a,pipeline:i},F);const s={renderWidth:0,renderHeight:0,numNgonsRendered:0,totalRenderTimeMs:performance.now()};a=Object.freeze({...V,...a});for(const e of Object.keys(D))void 0===i[e]&&(i[e]=D[e]);if(n?.(a,T),n?.(i,I),void 0===e)r?.("object"==typeof a.resolution&&"number"==typeof a.resolution.width&&"number"==typeof a.resolution.height,"No on-screen render target given. Off-screen rendering requires `options.resolution` to be an object of the form {width, height}.");else if("string"==typeof e){const t=e;e=document.getElementById(e),r?.(e instanceof HTMLCanvasElement,`The render target <canvas id="${t}"> doesn't exist in the document.`)}else r?.(e instanceof HTMLCanvasElement,`The render target ${e} isn't an instance of HTMLCanvasElement.`);const f=function(e={},t={}){const r=$(e.context);if(r.contextName=e.context,r.useDepthBuffer=Boolean(e.useDepthBuffer),r.useBackfaceCulling=Boolean(e.useBackfaceCulling),r.lights=e.lights,r.renderScale="number"==typeof e.resolution?e.resolution:void 0,r.renderWidth=e.resolution.width,r.renderHeight=e.resolution.height,r.nearPlaneDistance=e.nearPlane,r.farPlaneDistance=e.farPlane,r.fov=e.fov,r.cameraDirection=e.cameraDirection,r.cameraPosition=e.cameraPosition,r.useFullInterpolation=Boolean(e.useFullInterpolation),r.useFragmentBuffer=Boolean(e.useFragmentBuffer||r.usePixelShader&&r.pixel_shader?.toString().match(/{(.+)?}/)[1].includes("fragmentBuffer")),"object"==typeof e.fragments)for(const t of Object.keys(r.fragments))r.fragments[t]=e.fragments[t]??!1;else for(const e of Object.keys(r.fragments))r.fragments[e]=r.useFragmentBuffer;return r.pipeline.ngon_sorter=t.ngonSorter,r.pipeline.rasterizer=t.rasterizer,r.pipeline.transform_clip_lighter=t.transformClipLighter,r.pipeline.surface_wiper=t.surfaceWiper,r.usePixelShader=Boolean(t.pixelShader),r.pipeline.pixel_shader=t.pixelShader,r.useVertexShader=Boolean(t.vertexShader),r.pipeline.vertex_shader=t.vertexShader,r.useCanvasShader=Boolean(t.canvasShader),r.pipeline.canvas_shader=t.canvasShader,r.pipeline.raster_path=t.rasterPath,r}(a,i);{const i=function(e,t){n?.({canvasElement:e,renderContext:t},X);const a=void 0===e;let i,s,f;try{({surfaceWidth:i,surfaceHeight:s,canvasElement:e,canvasContext:f}=a?function(e){return{surfaceWidth:e.renderWidth,surfaceHeight:e.renderHeight,canvasContext:{createImageData:function(e,t){return new ImageData(e,t)}}}}(t):function(e,t){const n=t?.getContext("2d");let a,o;return r?.(t instanceof Element&&n,"Invalid canvas element"),"number"==typeof e.renderScale?(a=Math.floor(parseInt(window.getComputedStyle(t).getPropertyValue("width"))*e.renderScale),o=Math.floor(parseInt(window.getComputedStyle(t).getPropertyValue("height"))*e.renderScale),r?.(a>0&&o>0,"Failed to query the dimensions of the target canvas")):(r?.("number"==typeof e.renderWidth&&"number"==typeof e.renderHeight,"Invalid render resolution"),a=e.renderWidth,o=e.renderHeight),t.setAttribute("width",a),t.setAttribute("height",o),{surfaceWidth:a,surfaceHeight:o,canvasElement:t,canvasContext:n}}(t,e)),function(e,t,r,n){void 0!==t.pixelBuffer&&t.pixelBuffer.width==r&&t.pixelBuffer.height==n||(t.pixelBuffer=e.createImageData(r,n),t.pixelBuffer8=new Uint8ClampedArray(t.pixelBuffer.data.buffer),t.pixelBuffer32=new Uint32Array(t.pixelBuffer.data.buffer)),!t.useFragmentBuffer||t.fragmentBuffer.width==r&&t.fragmentBuffer.height==n||t.fragmentBuffer.resize(r,n),!t.useDepthBuffer||t.depthBuffer.width==r&&t.depthBuffer.height==n&&t.depthBuffer.data.length||t.depthBuffer.resize(r,n)}(f,t,i,s)}catch(e){return console.error(e),null}const u=o.multiply(o.rotating(t.cameraDirection.x,t.cameraDirection.y,t.cameraDirection.z),o.translating(-t.cameraPosition.x,-t.cameraPosition.y,-t.cameraPosition.z)),d=function(e=0,t=0,r=0,n=0){const a=Math.tan(e/2),i=r-n;return o(1/(a*t),0,0,0,0,1/a,0,0,0,0,(-r-n)/i,1,0,0,2*n*(r/i),0)}(t.fov*(Math.PI/180),i/s,t.nearPlaneDistance,t.farPlaneDistance),h=function(e=0,t=0){const r=e/2,n=t/2;return o(r,0,0,0,0,-n,0,0,0,0,1,0,r-.5,n-.5,0,1)}(i+1,s+1),m={$constructor:"Surface",width:i,height:s,display_meshes:function(e=[]){if(t.pipeline.surface_wiper?.(t),e.length){if(function(e,t=[p()]){r?.(t instanceof Array,"Invalid arguments to n-gon cache initialization.");const n=e.vertexCache,a=e.vertexNormalCache;let o=0;for(const e of t)for(const t of e.ngons)o+=t.vertices.length;if(!n||!n.vertices.length||n.vertices.length<o){const e=o-n.vertices.length;n.vertices.push(...new Array(e).fill().map((e=>l())))}if(n.count=0,!a||!a.normals.length||a.normals.length<o){const e=o-a.normals.length;a.normals.push(...new Array(e).fill().map((e=>c())))}a.count=0}(t,e),function(e,t=[p()]){r?.(t instanceof Array,"Invalid arguments to n-gon cache initialization.");const n=e.ngonCache,a=t.reduce(((e,t)=>e+t.ngons.length),0);if(!n||!n.ngons.length||n.ngons.length<a){const e=a-n.ngons.length;n.ngons.push(...new Array(e).fill().map((e=>p())))}n.count=0}(t,e),t.pipeline.transform_clip_lighter)for(const r of e)t.pipeline.transform_clip_lighter({renderContext:t,mesh:r,cameraMatrix:u,perspectiveMatrix:d,screenSpaceMatrix:h});t.pipeline.ngon_sorter?.(t),function(e){for(const t of e)if(t.material.texture&&"affine"===t.material.textureMapping){let e=0==(t.material.texture.width&t.material.texture.width-1),r=0==(t.material.texture.height&t.material.texture.height-1);0===t.material.texture.width&&(e=!1),0===t.material.texture.height&&(r=!1),e&&r||(t.material.textureMapping="affine-npot")}}(t.screenSpaceNgons)}t.pipeline.rasterizer?.(t),t.usePixelShader&&t.pipeline.pixel_shader(t),a||(t.useCanvasShader?t.pipeline.canvas_shader(f,t.pixelBuffer):f.putImageData(t.pixelBuffer,0,0))},is_in_view:function(){if(a)return!0;const t=window.innerHeight,r=e.getBoundingClientRect();return r.top>-r.height&&r.top<t}};return n?.(m,Y),m}(e,f);f.resolution.width=s.renderWidth=i.width,f.resolution.height=s.renderHeight=i.height,!i||a.hibernateWhenTargetNotVisible&&!i.is_in_view()||(i.display_meshes(t),s.numNgonsRendered=f.screenSpaceNgons.length)}return s.totalRenderTimeMs=performance.now()-s.totalRenderTimeMs,s},color:u,context:$.list,light:function(e=0,t=0,r=0,a={}){n?.({x:e,y:t,z:r,options:a},U);const o={$constructor:"Light",x:e,y:t,z:r,...a};return n?.(o,q),o},mesh:function(e=[p()],t={}){n?.({ngons:e,transform:t},L);const r={$constructor:"Mesh",ngons:e,...structuredClone(_),...t};return n?.(r,N),r},matrix:o,ngon:p,texture:K,vector:c,vertex:l};var re=self;for(var ne in t)re[ne]=t[ne];t.__esModule&&Object.defineProperty(re,"__esModule",{value:!0})})();